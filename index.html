<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistencias â€” Redes & TICs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');

:root {
  --bg:       #080b12;
  --s1:       #0e1220;
  --s2:       #141828;
  --s3:       #1b2035;
  --border:   #1e2540;
  --border2:  #252d48;

  --amber:    #f59e0b;
  --amber-d:  #92400e;
  --violet:   #8b5cf6;
  --violet-d: #4c1d95;
  --rose:     #f43f5e;
  --teal:     #14b8a6;
  --sky:      #38bdf8;

  --green:    #22c55e;
  --red:      #ef4444;
  --blue:     #60a5fa;
  --yellow:   #eab308;

  --text:     #e2e8f4;
  --muted:    #5a6a8a;
  --muted2:   #3a4560;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);color:var(--text);
  font-family:'Plus Jakarta Sans',sans-serif;
  min-height:100vh;
  background-image:
    radial-gradient(ellipse 60% 40% at 15% -5%, rgba(245,158,11,.06) 0%, transparent 70%),
    radial-gradient(ellipse 50% 35% at 85% 105%, rgba(139,92,246,.07) 0%, transparent 70%);
}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{display:flex;min-height:100vh}

.sidebar{
  width:240px;flex-shrink:0;
  background:var(--s1);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  position:fixed;top:0;left:0;height:100vh;overflow-y:auto;
  scrollbar-width:thin;scrollbar-color:var(--border2) transparent;
  z-index:200;
  transition:transform .25s ease;
}
.sidebar.hidden{transform:translateX(-100%);}

.sidebar-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:199;
}
.sidebar-overlay.show{display:block;}

/* push content when sidebar visible */
.content{margin-left:240px;transition:margin-left .25s ease;}
.sidebar.hidden ~ .content, .content.no-sidebar{margin-left:0;}

.sidebar-logo{
  padding:22px 20px 16px;
  border-bottom:1px solid var(--border);
  font-size:1.15rem;font-weight:800;letter-spacing:-0.5px;
}
.sidebar-logo span{color:var(--amber);}
.sidebar-logo small{display:block;font-size:0.7rem;font-weight:400;color:var(--muted);margin-top:2px;letter-spacing:0;}

.nav-section{padding:14px 12px 4px;}
.nav-label{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);padding:0 8px;margin-bottom:6px;}

.nav-item{
  display:flex;align-items:center;gap:9px;
  padding:8px 10px;border-radius:8px;
  font-size:0.82rem;font-weight:500;color:var(--muted);
  cursor:pointer;transition:all .15s;border:none;background:transparent;
  width:100%;text-align:left;
}
.nav-item:hover{background:var(--s2);color:var(--text);}
.nav-item.active{background:var(--s3);color:var(--text);font-weight:600;}
.nav-item .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dot.amber{background:var(--amber);}
.dot.violet{background:var(--violet);}
.dot.teal{background:var(--teal);}
.dot.rose{background:var(--rose);}
.dot.sky{background:var(--sky);}

.nav-mod{padding-left:28px;font-size:0.79rem;}
.nav-mod .dot{width:5px;height:5px;}
.nav-sub-label{font-size:0.68rem;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted2);padding:6px 18px 2px;display:block;}

.sidebar-footer{margin-top:auto;padding:14px 12px;border-top:1px solid var(--border);}

/* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{display:flex;flex-direction:column;min-width:0;min-height:100vh;}

.topbar{
  padding:14px 28px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
  background:rgba(8,11,18,.95);backdrop-filter:blur(12px);
  position:sticky;top:0;z-index:100;
}
.topbar-title{font-size:1rem;font-weight:700;flex:1;min-width:0;}
.topbar-date{font-size:0.78rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}

.page{padding:24px 28px;display:none;}
.page.active{display:block;}

/* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:16px 18px;}
.stat .v{font-family:'JetBrains Mono',monospace;font-size:1.9rem;font-weight:600;line-height:1;margin-bottom:4px;}
.stat .l{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;}
.v.green{color:var(--green);} .v.red{color:var(--red);}
.v.yellow{color:var(--yellow);} .v.amber{color:var(--amber);} .v.blue{color:var(--blue);}

/* â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.toolbar-h{font-weight:700;font-size:0.9rem;flex:1;}

.inp{
  background:var(--s2);border:1px solid var(--border);border-radius:7px;
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.82rem;
  padding:6px 10px;outline:none;transition:border-color .2s;
}
.inp:focus{border-color:var(--amber);}
.inp[type=date]::-webkit-calendar-picker-indicator{filter:invert(.5);cursor:pointer;}

.search-w{position:relative;}
.search-w .inp{padding-left:28px;width:170px;}
.search-ico{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.8rem;pointer-events:none;}

.thr-wrap{display:flex;align-items:center;gap:5px;font-size:.78rem;color:var(--muted);}
select.inp{cursor:pointer;}

.btn{
  padding:6px 13px;border-radius:7px;border:none;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:0.78rem;
  transition:all .18s;white-space:nowrap;
}
.btn-amber{background:var(--amber);color:#000;}
.btn-amber:hover{opacity:.85;}
.btn-green{background:var(--green);color:#000;}
.btn-green:hover{opacity:.85;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);}
.btn-outline:hover{border-color:var(--amber);color:var(--amber);}
.btn-red{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:var(--red);}
.btn-red:hover{background:rgba(239,68,68,.25);}
.btn-violet{background:var(--violet);color:#fff;}
.btn-violet:hover{opacity:.85;}

/* â”€â”€ ALERT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-bar{
  background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.2);
  border-radius:9px;padding:10px 14px;margin-bottom:14px;
  font-size:.83rem;color:var(--red);display:none;gap:8px;line-height:1.5;align-items:flex-start;
}
.alert-bar.show{display:flex;}

/* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{background:var(--s1);border:1px solid var(--border);border-radius:13px;overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead{background:var(--s2);}
th{
  padding:11px 14px;text-align:left;
  font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;
  color:var(--muted);border-bottom:1px solid var(--border);
}
td{padding:10px 14px;border-bottom:1px solid rgba(30,37,64,.6);font-size:.85rem;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr{transition:background .12s;}
tr:hover td{background:rgba(245,158,11,.03);}

.aname{font-weight:600;font-size:.85rem;}
.asub{font-size:.71rem;color:var(--muted);margin-top:2px;}

/* attendance buttons */
.abgroup{display:flex;gap:4px;}
.ab{
  padding:4px 9px;border-radius:6px;border:1.5px solid var(--border2);
  cursor:pointer;font-size:.72rem;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;
  background:transparent;color:var(--muted2);transition:all .14s;
}
.ab:hover{transform:translateY(-1px);}
.ab.presente{background:rgba(34,197,94,.13);border-color:var(--green);color:var(--green);}
.ab.falta{background:rgba(239,68,68,.13);border-color:var(--red);color:var(--red);}
.ab.permiso{background:rgba(96,165,250,.13);border-color:var(--blue);color:var(--blue);}

/* history dots */
.hdots{display:flex;gap:3px;flex-wrap:wrap;max-width:150px;}
.hd{width:8px;height:8px;border-radius:50%;flex-shrink:0;cursor:default;}
.hd.Presente{background:var(--green);}
.hd.Falta{background:var(--red);}
.hd.Permiso{background:var(--blue);}
.hd.none{background:var(--border2);}

/* pct bar */
.pbar{display:flex;align-items:center;gap:7px;}
.pbg{flex:1;height:4px;background:var(--border2);border-radius:99px;overflow:hidden;max-width:80px;}
.pfill{height:100%;border-radius:99px;transition:width .3s;}
.pval{font-size:.77rem;font-weight:600;min-width:34px;font-family:'JetBrains Mono',monospace;}

/* â”€â”€ MÃ“DULO HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mod-header{
  display:flex;align-items:center;gap:12px;margin-bottom:18px;
  padding-bottom:14px;border-bottom:1px solid var(--border);
}
.mod-badge{
  padding:4px 12px;border-radius:99px;font-size:.72rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.6px;
}
.mod-badge.manana{background:rgba(245,158,11,.12);color:var(--amber);border:1px solid rgba(245,158,11,.25);}
.mod-badge.tarde{background:rgba(139,92,246,.12);color:var(--violet);border:1px solid rgba(139,92,246,.25);}
.mod-info{font-size:.8rem;color:var(--muted);}
.mod-info strong{color:var(--text);}

/* â”€â”€ ALUMNOS PANEL (add/manage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel{background:var(--s1);border:1px solid var(--border);border-radius:13px;padding:20px;margin-bottom:16px;}
.panel-title{font-weight:700;font-size:.88rem;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.panel-title span{color:var(--amber);}

.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;}
.fgroup{display:flex;flex-direction:column;gap:4px;}
.flabel{font-size:.72rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.finp{
  background:var(--s2);border:1px solid var(--border);border-radius:7px;
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;
  padding:7px 10px;outline:none;transition:border-color .2s;width:100%;
}
.finp:focus{border-color:var(--amber);}
.form-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;}

/* â”€â”€ PERSONALIZADOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pers-card{
  background:var(--s1);border:1px solid var(--border);border-radius:13px;
  padding:18px;margin-bottom:12px;transition:border-color .2s;
}
.pers-card:hover{border-color:var(--border2);}
.pers-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;}
.pers-name{font-weight:700;font-size:.95rem;}
.pers-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;}
.pmeta{font-size:.75rem;color:var(--muted);display:flex;align-items:center;gap:4px;}
.pers-actions{display:flex;gap:6px;flex-shrink:0;}
.pers-clases{border-top:1px solid var(--border);padding-top:12px;}
.pers-clases-list{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
.clase-chip{
  display:flex;align-items:center;gap:5px;
  padding:4px 10px;border-radius:6px;font-size:.75rem;
  background:var(--s2);border:1px solid var(--border);
}
.clase-chip .cc-date{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);}
.clase-chip .cc-val{font-weight:700;}
.cc-val.Presente{color:var(--green);}
.cc-val.Falta{color:var(--red);}
.cc-val.Permiso{color:var(--blue);}
.clase-add{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}

/* â”€â”€ EMPTY / TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:48px;color:var(--muted);}
.empty .ei{font-size:2.5rem;margin-bottom:10px;}

.toast{
  position:fixed;bottom:22px;right:22px;
  background:var(--s2);border:1px solid var(--amber);color:var(--text);
  border-radius:9px;padding:11px 18px;font-size:.83rem;z-index:999;
  transform:translateY(60px);opacity:0;transition:all .28s;pointer-events:none;
  max-width:320px;line-height:1.4;
}
.toast.show{transform:translateY(0);opacity:1;}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.7);z-index:300;
  align-items:center;justify-content:center;padding:20px;
}
.overlay.show{display:flex;}
.modal{
  background:var(--s1);border:1px solid var(--border2);border-radius:16px;
  padding:28px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;
}
.modal h3{font-size:1rem;font-weight:700;margin-bottom:6px;}
.modal p{color:var(--muted);font-size:.83rem;margin-bottom:18px;line-height:1.5;}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;}

/* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dash-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:20px;}
.dash-card{background:var(--s1);border:1px solid var(--border);border-radius:13px;padding:20px;}
.dash-card h4{font-size:.82rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:14px;}
.dash-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(30,37,64,.5);}
.dash-row:last-child{border-bottom:none;}
.dash-row .dr-name{font-size:.83rem;}
.dash-row .dr-pct{font-size:.8rem;font-family:'JetBrains Mono',monospace;font-weight:600;}

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hamburger{
  display:flex;align-items:center;justify-content:center;
  width:36px;height:36px;border-radius:8px;border:1px solid var(--border);
  background:var(--s2);cursor:pointer;flex-shrink:0;font-size:1rem;
  transition:all .15s;
}
.hamburger:hover{border-color:var(--amber);color:var(--amber);}

@media(max-width:900px){
  .content{margin-left:0!important;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .dash-grid{grid-template-columns:1fr;}
}
@media(max-width:600px){
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .page{padding:16px;}
  .topbar{padding:12px 16px;}
}
</style>
</head>
<body>

<div class="layout">

<!-- â•â• SIDEBAR OVERLAY â•â• -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    Redes <span>&</span> TICs
    <small>Sistema de Asistencias</small>
  </div>

  <div class="nav-section">
    <div class="nav-label">General</div>
    <button class="nav-item active" onclick="goPage('dashboard')">
      <div class="dot sky"></div> Resumen General
    </button>
  </div>

  <div class="nav-section">
    <div class="nav-label">â˜€ï¸ Turno MaÃ±ana</div>
    <button class="nav-item nav-mod" onclick="goPage('M-1')"><div class="dot amber"></div>MÃ³dulo 1</button>
    <button class="nav-item nav-mod" onclick="goPage('M-2')"><div class="dot amber"></div>MÃ³dulo 2</button>
    <button class="nav-item nav-mod" onclick="goPage('M-3')"><div class="dot amber"></div>MÃ³dulo 3</button>
    <button class="nav-item nav-mod" onclick="goPage('M-4')"><div class="dot amber"></div>MÃ³dulo 4</button>
  </div>

  <div class="nav-section">
    <div class="nav-label">ğŸŒ™ Turno Tarde</div>
    <button class="nav-item nav-mod" onclick="goPage('T-1')"><div class="dot violet"></div>MÃ³dulo 1</button>
    <button class="nav-item nav-mod" onclick="goPage('T-2')"><div class="dot violet"></div>MÃ³dulo 2</button>
    <button class="nav-item nav-mod" onclick="goPage('T-3')"><div class="dot violet"></div>MÃ³dulo 3</button>
    <button class="nav-item nav-mod" onclick="goPage('T-4')"><div class="dot violet"></div>MÃ³dulo 4</button>
  </div>

  <div class="nav-section">
    <div class="nav-label">Individual</div>
    <button class="nav-item" onclick="goPage('personalizados')">
      <div class="dot teal"></div> Clases Personalizadas
    </button>
  </div>

  <div class="sidebar-footer">
    <button class="btn btn-green" style="width:100%" onclick="exportarTodo()">â¬‡ï¸ Exportar Excel</button>
  </div>
</nav>

<!-- â•â• CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="content">
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()" title="MenÃº">â˜°</button>
    <div class="topbar-title" id="topbarTitle">Resumen General</div>
    <div id="syncIndicator"></div>
    <button class="btn btn-outline" style="font-size:.72rem;padding:5px 10px" onclick="showCloudConfig()" title="Configurar guardado en la nube">â˜ï¸ Nube</button>
    <div class="topbar-date" id="topbarDate"></div>
  </div>

  <!-- â”€â”€ DASHBOARD â”€â”€ -->
  <div class="page active" id="page-dashboard">
    <div class="stats-grid">
      <div class="stat"><div class="v amber" id="d-total">0</div><div class="l">Alumnos totales</div></div>
      <div class="stat"><div class="v green"  id="d-pres">0</div><div class="l">Presentes hoy</div></div>
      <div class="stat"><div class="v red"    id="d-falt">0</div><div class="l">Faltas hoy</div></div>
      <div class="stat"><div class="v yellow" id="d-alert">0</div><div class="l">Con alertas</div></div>
      <div class="stat"><div class="v blue"   id="d-pers">0</div><div class="l">Personalizados</div></div>
    </div>
    <div class="dash-grid" id="dashCards"></div>
  </div>

  <!-- â”€â”€ MÃ“DULOS (se generan dinÃ¡micamente) â”€â”€ -->
  <!-- placeholder IDs: M-1, M-2, M-3, M-4, T-1, T-2, T-3, T-4 -->

  <!-- â”€â”€ PERSONALIZADOS â”€â”€ -->
  <div class="page" id="page-personalizados">
    <div class="panel">
      <div class="panel-title">â• <span>Agregar alumno personalizado</span></div>
      <div class="form-grid">
        <div class="fgroup"><div class="flabel">Nombre completo *</div><input class="finp" id="pNombre" placeholder="Apellidos y Nombres"></div>
        <div class="fgroup"><div class="flabel">TelÃ©fono / Contacto</div><input class="finp" id="pTel" placeholder="999 999 999"></div>
        <div class="fgroup"><div class="flabel">Tema / Materia</div><input class="finp" id="pTema" placeholder="Ej: Excel bÃ¡sico"></div>
        <div class="fgroup"><div class="flabel">Horario / DÃ­a</div><input class="finp" id="pHorario" placeholder="Ej: SÃ¡bados 10am"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-amber" onclick="agregarPersonalizado()">Agregar alumno</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbar-h">Alumnos Personalizados</div>
      <div class="search-w">
        <span class="search-ico">ğŸ”</span>
        <input class="inp search-w" id="persSearch" placeholder="Buscar..." oninput="renderPersonalizados()" style="padding-left:28px;width:170px;">
      </div>
    </div>

    <div id="persList"></div>
  </div>

</div><!-- /content -->
</div><!-- /layout -->

<div class="toast" id="toast"></div>

<div class="overlay" id="overlay">
  <div class="modal" id="modalBox">
    <h3 id="mTitle"></h3>
    <p id="mBody"></p>
    <div id="mExtra"></div>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-amber" id="mOk">Confirmar</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  state[key] = { alumnos:[{id,nombre}], asistencias:{id:{fecha:val}}, fechas:[] }
  keys: 'M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'

  personalizados:[{id,nombre,tel,tema,horario,clases:[{fecha,val}]}]
*/
let state = {};
let personalizados = [];
let currentPage = 'dashboard';
const today = new Date().toISOString().split('T')[0];

const TURNOS = {
  'M':{ label:'Turno MaÃ±ana', cls:'manana', color:'var(--amber)' },
  'T':{ label:'Turno Tarde',  cls:'tarde',  color:'var(--violet)' }
};
const MOD_NAMES = ['','MÃ³dulo 1','MÃ³dulo 2','MÃ³dulo 3','MÃ³dulo 4'];

// Init all module states empty
['M','T'].forEach(t=>[1,2,3,4].forEach(m=>{
  state[`${t}-${m}`] = { alumnos:[], asistencias:{}, fechas:[] };
}));

// â”€â”€ Init UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('topbarDate').textContent =
  new Date().toLocaleDateString('es',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

// Build module pages
['M','T'].forEach(t=>[1,2,3,4].forEach(m=>{
  const key = `${t}-${m}`;
  const div = document.createElement('div');
  div.className = 'page';
  div.id = `page-${key}`;
  div.innerHTML = buildModulePage(key);
  document.querySelector('.content').appendChild(div);
}));

renderDashboard();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));

  document.getElementById(`page-${id}`)?.classList.add('active');

  // Highlight nav
  document.querySelectorAll('.nav-item').forEach(n=>{
    if(n.getAttribute('onclick')===`goPage('${id}')`) n.classList.add('active');
  });

  currentPage = id;

  // Update topbar title
  let title = 'Resumen General';
  if(id==='personalizados') title = 'ğŸ‘¤ Clases Personalizadas';
  else if(id.includes('-')){
    const [t,m] = id.split('-');
    title = `${TURNOS[t].label} â€” MÃ³dulo ${m}`;
  }
  document.getElementById('topbarTitle').textContent = title;

  // Close sidebar on mobile after navigation
  if(window.innerWidth<900){
    document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('sidebarOverlay').classList.remove('show');
  }

  if(id==='dashboard') renderDashboard();
  else if(id==='personalizados') renderPersonalizados();
  else renderModule(id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD MODULE PAGE HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildModulePage(key){
  const [t,m] = key.split('-');
  const turno = TURNOS[t];
  return `
  <div class="mod-header">
    <span class="mod-badge ${turno.cls}">${turno.label}</span>
    <div class="mod-info">MÃ³dulo <strong>${m}</strong></div>
  </div>

  <!-- IMPORT PANEL -->
  <div class="panel" id="importPanel-${key}">
    <div class="panel-title">ğŸ“‚ <span>Importar desde Excel o cargar manualmente</span></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <label class="btn btn-amber" for="fileInput-${key}" style="cursor:pointer;">ğŸ“‚ Subir Excel de este mÃ³dulo</label>
      <input type="file" id="fileInput-${key}" accept=".xlsx,.xls" style="display:none" onchange="importExcel('${key}',this)">
      <button class="btn btn-outline" onclick="showAddAlumnoModal('${key}')">â• Agregar alumno manualmente</button>
    </div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:10px;line-height:1.7;">
      El Excel debe tener: <strong>Fila 1</strong> = fechas Â· <strong>Fila 2</strong> = nÃºmero de clase Â· <strong>Fila 3+</strong> = alumnos con valores <em>Presente / Falta / Permiso</em>. La Ãºltima fila con fÃ³rmulas se omite automÃ¡ticamente.
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
    <div class="stat"><div class="v green"  id="st-pres-${key}">0</div><div class="l">Presentes hoy</div></div>
    <div class="stat"><div class="v red"    id="st-falt-${key}">0</div><div class="l">Faltas hoy</div></div>
    <div class="stat"><div class="v blue"   id="st-perm-${key}">0</div><div class="l">Permisos hoy</div></div>
    <div class="stat"><div class="v yellow" id="st-alert-${key}">0</div><div class="l">Con alertas</div></div>
  </div>

  <div class="alert-bar" id="alertBar-${key}">âš ï¸ <span id="alertTxt-${key}"></span></div>

  <div class="toolbar">
    <div class="toolbar-h" id="modTitle-${key}">â€” alumnos</div>
    <div class="search-w">
      <span class="search-ico">ğŸ”</span>
      <input class="inp" id="search-${key}" placeholder="Buscar..." oninput="renderModule('${key}')" style="padding-left:28px;width:165px;">
    </div>
    <input type="date" class="inp" id="date-${key}" value="${today}" onchange="renderModule('${key}')">
    <div class="thr-wrap">âš ï¸ Alerta
      <select class="inp" id="thr-${key}" onchange="renderModule('${key}')">
        <option value="2">2 faltas</option>
        <option value="3" selected>3 faltas</option>
        <option value="4">4 faltas</option>
        <option value="5">5 faltas</option>
      </select>
    </div>
    <button class="btn btn-amber" onclick="marcarTodos('${key}','Presente')">âœ… Todos presentes</button>
    <button class="btn btn-outline" onclick="showAddAlumnoModal('${key}')">â• Alumno</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead><tr>
        <th>#</th><th>Alumno</th><th>Asistencia hoy</th>
        <th>Historial</th><th>% Asistencia</th><th></th>
      </tr></thead>
      <tbody id="tbody-${key}"></tbody>
    </table>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importExcel(key, input){
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result,{type:'binary',cellDates:true});
    // Try to find the right sheet, or just use first
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    const result = parseSheet(rows);
    if(!result){ showToast('âŒ No se pudieron leer los datos del archivo.'); return; }
    state[key] = result;
    renderModule(key);
    showToast(`âœ… ${result.alumnos.length} alumnos importados en ${key.replace('-',' MÃ³dulo ')}`);
    input.value='';
  };
  reader.readAsBinaryString(file);
}

function parseSheet(rows){
  if(!rows||rows.length<3) return null;
  const dateRow = rows[0];
  const dateColMap={};
  for(let c=1;c<dateRow.length;c++){
    const cell=dateRow[c];
    let d=null;
    if(cell instanceof Date) d=cell.toISOString().split('T')[0];
    else if(cell!==''&&cell!==null) d=normalizeDate(String(cell).trim());
    if(d) dateColMap[c]=d;
  }
  const fechas=[...new Set(Object.values(dateColMap))].sort();
  const alumnos=[],asistencias={};
  for(let r=2;r<rows.length;r++){
    const row=rows[r];
    const nombre=String(row[0]||'').trim();
    if(!nombre||nombre.length<2) continue;
    const low=nombre.toLowerCase();
    if(low.includes('total')||low.includes('nombre')||low.includes('alumno')||/^[=]/.test(nombre)) continue;
    // Skip formula rows
    if(String(row[1]||'').startsWith('=')) continue;
    const id=r;
    alumnos.push({id,nombre});
    asistencias[id]={};
    for(const[col,fecha] of Object.entries(dateColMap)){
      const raw=String(row[col]||'').trim();
      if(raw==='Presente'||raw==='Falta'||raw==='Permiso') asistencias[id][fecha]=raw;
    }
  }
  return alumnos.length>0?{alumnos,asistencias,fechas}:null;
}

function normalizeDate(s){
  if(/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/.test(s)){
    const p=s.replace(/\//g,'-').split('-');
    return `${p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
  }
  if(/^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/.test(s)){
    const p=s.split(/[-\/]/);
    return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  }
  const n=Number(s);
  if(!isNaN(n)&&n>40000&&n<60000)
    return new Date((n-25569)*86400*1000).toISOString().split('T')[0];
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModule(key){
  const d=state[key];
  const fecha=document.getElementById(`date-${key}`)?.value||today;
  const q=(document.getElementById(`search-${key}`)?.value||'').toLowerCase();
  const thr=parseInt(document.getElementById(`thr-${key}`)?.value||3);
  const filtered=d.alumnos.filter(a=>a.nombre.toLowerCase().includes(q));

  document.getElementById(`modTitle-${key}`).textContent=`${d.alumnos.length} alumno(s) registrado(s)`;

  let pres=0,falt=0,perm=0,alerts=0;
  const tbody=document.getElementById(`tbody-${key}`);
  if(!tbody) return;
  tbody.innerHTML='';

  if(filtered.length===0){
    tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="ei">${d.alumnos.length===0?'ğŸ“‹':'ğŸ”'}</div>${d.alumnos.length===0?'Sin alumnos. Importa un Excel o agrega manualmente.':'Sin resultados.'}</div></td></tr>`;
  }

  filtered.forEach((a,idx)=>{
    const reg=d.asistencias[a.id]||{};
    const hoy=reg[fecha]||'';
    if(hoy==='Presente') pres++;
    else if(hoy==='Falta') falt++;
    else if(hoy==='Permiso') perm++;

    const hist=d.fechas.filter(f=>f!==fecha).slice(-15);
    const totalF=Object.values(reg).filter(v=>v==='Falta').length;
    const totalDias=d.fechas.filter(f=>f<=fecha).length;
    const totalOk=Object.values(reg).filter(v=>v==='Presente'||v==='Permiso').length;
    const pct=totalDias>0?Math.round((totalOk/totalDias)*100):0;
    const enAlerta=totalF>=thr;
    if(enAlerta) alerts++;

    const barCol=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.75rem">${idx+1}</td>
      <td>
        <div class="aname">${a.nombre}</div>
        ${enAlerta?`<div class="asub" style="color:var(--red)">âš ï¸ ${totalF} falta(s) acumulada(s)</div>`:''}
      </td>
      <td>
        <div class="abgroup">
          <button class="ab${hoy==='Presente'?' presente':''}" onclick="setAsist('${key}',${a.id},'${fecha}','Presente')">âœ… Presente</button>
          <button class="ab${hoy==='Falta'?' falta':''}"    onclick="setAsist('${key}',${a.id},'${fecha}','Falta')">âŒ Falta</button>
          <button class="ab${hoy==='Permiso'?' permiso':''}" onclick="setAsist('${key}',${a.id},'${fecha}','Permiso')">ğŸ”µ Permiso</button>
        </div>
      </td>
      <td>
        <div class="hdots">
          ${hist.map(f=>{const v=reg[f]||'none';return`<div class="hd ${v}" title="${f}: ${v}"></div>`;}).join('')}
        </div>
      </td>
      <td>
        <div class="pbar">
          <div class="pbg"><div class="pfill" style="width:${pct}%;background:${barCol}"></div></div>
          <span class="pval" style="color:${barCol}">${pct}%</span>
        </div>
      </td>
      <td>
        <button class="btn btn-red" style="padding:3px 8px;font-size:.7rem" onclick="eliminarAlumno('${key}',${a.id})">âœ•</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById(`st-pres-${key}`).textContent=pres;
  document.getElementById(`st-falt-${key}`).textContent=falt;
  document.getElementById(`st-perm-${key}`).textContent=perm;
  document.getElementById(`st-alert-${key}`).textContent=alerts;

  const enAlertaList=d.alumnos.filter(a=>Object.values(d.asistencias[a.id]||{}).filter(v=>v==='Falta').length>=thr);
  const ab=document.getElementById(`alertBar-${key}`);
  if(enAlertaList.length>0){
    ab.classList.add('show');
    document.getElementById(`alertTxt-${key}`).innerHTML=
      `<strong>${enAlertaList.length} alumno(s) con ${thr}+ faltas:</strong> ${enAlertaList.map(a=>a.nombre.split(' ')[0]).join(', ')}`;
  } else ab.classList.remove('show');
}

function setAsist(key,id,fecha,val){
  const d=state[key];
  if(!d.asistencias[id]) d.asistencias[id]={};
  if(d.asistencias[id][fecha]===val) delete d.asistencias[id][fecha];
  else{
    d.asistencias[id][fecha]=val;
    if(!d.fechas.includes(fecha)){d.fechas.push(fecha);d.fechas.sort();}
  }
  renderModule(key);
  scheduleSync();
}

function marcarTodos(key,val){
  const d=state[key];
  const fecha=document.getElementById(`date-${key}`)?.value||today;
  d.alumnos.forEach(a=>{
    if(!d.asistencias[a.id]) d.asistencias[a.id]={};
    d.asistencias[a.id][fecha]=val;
  });
  if(!d.fechas.includes(fecha)){d.fechas.push(fecha);d.fechas.sort();}
  renderModule(key);
  showToast('âœ… Todos marcados como Presente');
  scheduleSync();
}

function eliminarAlumno(key,id){
  showModal('Eliminar alumno','Â¿Seguro que deseas eliminar este alumno y todos sus registros?',()=>{
    const d=state[key];
    d.alumnos=d.alumnos.filter(a=>a.id!==id);
    delete d.asistencias[id];
    closeModal();
    renderModule(key);
    showToast('Alumno eliminado');
    scheduleSync();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD ALUMNO MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAddAlumnoModal(key){
  const [t,m]=key.split('-');
  const label=`${TURNOS[t].label} â€” MÃ³dulo ${m}`;
  showModal(
    `â• Agregar alumno â€” ${label}`,
    'Escribe el nombre completo del alumno para aÃ±adirlo a este mÃ³dulo.',
    ()=>{
      const nombre=document.getElementById('addNombreInp')?.value.trim();
      if(!nombre){showToast('âš ï¸ Escribe un nombre');return;}
      const d=state[key];
      const id=Date.now();
      d.alumnos.push({id,nombre});
      d.asistencias[id]={};
      closeModal();
      renderModule(key);
      showToast(`âœ… "${nombre}" agregado al mÃ³dulo`);
      scheduleSync();
    },
    `<div class="fgroup" style="margin-top:4px">
      <div class="flabel">Nombre completo</div>
      <input class="finp" id="addNombreInp" placeholder="Apellidos y Nombres" autofocus>
    </div>`
  );
  setTimeout(()=>document.getElementById('addNombreInp')?.focus(),100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSONALIZADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function agregarPersonalizado(){
  const nombre=document.getElementById('pNombre').value.trim();
  if(!nombre){showToast('âš ï¸ El nombre es obligatorio');return;}
  const p={
    id:Date.now(),
    nombre,
    tel:document.getElementById('pTel').value.trim(),
    tema:document.getElementById('pTema').value.trim(),
    horario:document.getElementById('pHorario').value.trim(),
    clases:[]
  };
  personalizados.push(p);
  ['pNombre','pTel','pTema','pHorario'].forEach(id=>document.getElementById(id).value='');
  renderPersonalizados();
  showToast(`âœ… "${nombre}" agregado a personalizados`);
  scheduleSync();
}

function registrarClasePersonalizada(pid,fecha,val){
  const p=personalizados.find(x=>x.id===pid);
  if(!p) return;
  const idx=p.clases.findIndex(c=>c.fecha===fecha);
  if(idx>=0&&p.clases[idx].val===val) p.clases.splice(idx,1);
  else if(idx>=0) p.clases[idx].val=val;
  else p.clases.push({fecha,val});
  p.clases.sort((a,b)=>a.fecha.localeCompare(b.fecha));
  renderPersonalizados();
  scheduleSync();
}

function eliminarPersonalizado(pid){
  showModal('Eliminar alumno','Â¿Seguro que deseas eliminar este alumno personalizado?',()=>{
    personalizados=personalizados.filter(p=>p.id!==pid);
    closeModal();
    renderPersonalizados();
    showToast('Alumno eliminado');
    scheduleSync();
  });
}

function renderPersonalizados(){
  const q=(document.getElementById('persSearch')?.value||'').toLowerCase();
  const filtered=personalizados.filter(p=>p.nombre.toLowerCase().includes(q));
  const container=document.getElementById('persList');

  if(filtered.length===0){
    container.innerHTML=`<div class="empty"><div class="ei">ğŸ‘¤</div>${personalizados.length===0?'Sin alumnos personalizados aÃºn. AgrÃ©galos con el formulario de arriba.':'Sin resultados.'}</div>`;
    return;
  }

  container.innerHTML=filtered.map(p=>{
    const totalC=p.clases.length;
    const totalP=p.clases.filter(c=>c.val==='Presente').length;
    const pct=totalC>0?Math.round((totalP/totalC)*100):0;
    const pcol=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';

    return`
    <div class="pers-card">
      <div class="pers-card-top">
        <div>
          <div class="pers-name">${p.nombre}</div>
          <div class="pers-meta">
            ${p.tel?`<div class="pmeta">ğŸ“ ${p.tel}</div>`:''}
            ${p.tema?`<div class="pmeta">ğŸ“š ${p.tema}</div>`:''}
            ${p.horario?`<div class="pmeta">ğŸ• ${p.horario}</div>`:''}
            <div class="pmeta" style="color:${pcol};font-weight:600">${totalC} clase(s) Â· ${pct}% asistencia</div>
          </div>
        </div>
        <div class="pers-actions">
          <button class="btn btn-red" onclick="eliminarPersonalizado(${p.id})">âœ• Eliminar</button>
        </div>
      </div>
      <div class="pers-clases">
        <div class="pers-clases-list">
          ${p.clases.length===0?`<span style="font-size:.78rem;color:var(--muted)">Sin clases registradas aÃºn</span>`:''}
          ${p.clases.map(c=>`
            <div class="clase-chip" title="Click para eliminar" onclick="registrarClasePersonalizada(${p.id},'${c.fecha}','${c.val}')">
              <span class="cc-date">${c.fecha}</span>
              <span class="cc-val ${c.val}">${c.val}</span>
            </div>`).join('')}
        </div>
        <div class="clase-add">
          <span style="font-size:.75rem;color:var(--muted);font-weight:600">Registrar clase:</span>
          <input type="date" class="inp" id="pd-${p.id}" value="${today}" style="font-size:.78rem;padding:4px 8px">
          <button class="btn btn-green" style="font-size:.74rem;padding:4px 10px" onclick="registrarClasePersonalizada(${p.id},document.getElementById('pd-${p.id}').value,'Presente')">âœ… Presente</button>
          <button class="btn btn-red"   style="font-size:.74rem;padding:4px 10px" onclick="registrarClasePersonalizada(${p.id},document.getElementById('pd-${p.id}').value,'Falta')">âŒ Falta</button>
          <button class="btn btn-outline" style="font-size:.74rem;padding:4px 10px;border-color:var(--blue);color:var(--blue)" onclick="registrarClasePersonalizada(${p.id},document.getElementById('pd-${p.id}').value,'Permiso')">ğŸ”µ Permiso</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  let totalAl=0,todayPres=0,todayFalt=0,totalAlerts=0;
  const keys=['M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'];
  const thr=3;

  keys.forEach(key=>{
    const d=state[key];
    totalAl+=d.alumnos.length;
    d.alumnos.forEach(a=>{
      const reg=d.asistencias[a.id]||{};
      if(reg[today]==='Presente') todayPres++;
      if(reg[today]==='Falta')    todayFalt++;
      if(Object.values(reg).filter(v=>v==='Falta').length>=thr) totalAlerts++;
    });
  });

  document.getElementById('d-total').textContent=totalAl;
  document.getElementById('d-pres').textContent=todayPres;
  document.getElementById('d-falt').textContent=todayFalt;
  document.getElementById('d-alert').textContent=totalAlerts;
  document.getElementById('d-pers').textContent=personalizados.length;

  // Cards per turno
  const dashCards=document.getElementById('dashCards');
  dashCards.innerHTML=['M','T'].map(t=>{
    const turnKeys=[1,2,3,4].map(m=>`${t}-${m}`);
    const rows=turnKeys.map(key=>{
      const d=state[key];
      const m=key.split('-')[1];
      const total=d.alumnos.length;
      if(total===0) return `<div class="dash-row"><span class="dr-name" style="color:var(--muted)">MÃ³dulo ${m} â€” sin datos</span><span></span></div>`;
      const vals=d.alumnos.flatMap(a=>Object.values(d.asistencias[a.id]||{}));
      const P=vals.filter(v=>v==='Presente').length;
      const tot=vals.length;
      const pct=tot>0?Math.round((P/tot)*100):0;
      const col=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';
      return`<div class="dash-row">
        <span class="dr-name" style="cursor:pointer;text-decoration:underline;text-decoration-color:var(--border2)" onclick="goPage('${key}')">MÃ³dulo ${m} Â· ${total} alumnos</span>
        <span class="dr-pct" style="color:${col}">${pct}%</span>
      </div>`;
    }).join('');
    return`<div class="dash-card">
      <h4>${TURNOS[t].label}</h4>
      ${rows}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarTodo(){
  showModal('â¬‡ï¸ Exportar Excel','Se generarÃ¡n dos archivos: uno con los mÃ³dulos de ambos turnos y otro con los alumnos personalizados.',()=>{
    closeModal();
    exportModulos();
    if(personalizados.length>0) exportPersonalizados();
    showToast('ğŸ“¥ Excel(s) exportado(s) correctamente');
  });
}

function exportModulos(){
  const wb=XLSX.utils.book_new();
  ['M','T'].forEach(t=>[1,2,3,4].forEach(m=>{
    const key=`${t}-${m}`;
    const d=state[key];
    if(d.alumnos.length===0) return;
    const allF=[...d.fechas].sort();
    const header=['#','Nombre',...allF,'Presentes','Faltas','Permisos','% Asistencia'];
    const rows=[header];
    d.alumnos.forEach((a,i)=>{
      const reg=d.asistencias[a.id]||{};
      const row=[i+1,a.nombre];
      let P=0,F=0,Pm=0;
      allF.forEach(f=>{const v=reg[f]||'';row.push(v);if(v==='Presente')P++;else if(v==='Falta')F++;else if(v==='Permiso')Pm++;});
      const tot=P+F+Pm;
      row.push(P,F,Pm,tot>0?Math.round(((P+Pm)/tot)*100)+'%':'â€”');
      rows.push(row);
    });
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[{wch:4},{wch:30},...allF.map(()=>({wch:12})),{wch:11},{wch:11},{wch:11},{wch:14}];
    const label=`${t==='M'?'MaÃ±ana':'Tarde'} MÃ³dulo ${m}`;
    XLSX.utils.book_append_sheet(wb,ws,label);
  }));
  if(wb.SheetNames.length>0)
    XLSX.writeFile(wb,`asistencias_modulos_${today}.xlsx`);
}

function exportPersonalizados(){
  const wb=XLSX.utils.book_new();
  const rows=[['Nombre','TelÃ©fono','Tema/Materia','Horario','Total Clases','Presentes','Faltas','Permisos','% Asistencia']];
  personalizados.forEach(p=>{
    const P=p.clases.filter(c=>c.val==='Presente').length;
    const F=p.clases.filter(c=>c.val==='Falta').length;
    const Pm=p.clases.filter(c=>c.val==='Permiso').length;
    const tot=p.clases.length;
    rows.push([p.nombre,p.tel,p.tema,p.horario,tot,P,F,Pm,tot>0?Math.round(((P+Pm)/tot)*100)+'%':'â€”']);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:30},{wch:16},{wch:20},{wch:18},{wch:12},{wch:12},{wch:12},{wch:12},{wch:14}];
  XLSX.utils.book_append_sheet(wb,ws,'Personalizados');

  // Detail sheet
  const det=[['Alumno','Fecha','Asistencia']];
  personalizados.forEach(p=>{
    p.clases.forEach(c=>det.push([p.nombre,c.fecha,c.val]));
  });
  const ws2=XLSX.utils.aoa_to_sheet(det);
  ws2['!cols']=[{wch:30},{wch:14},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws2,'Detalle Clases');

  XLSX.writeFile(wb,`asistencias_personalizados_${today}.xlsx`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’¾ AUTO-SAVE â€” localStorage + JSONBin con proxy CORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let JSONBIN_KEY = localStorage.getItem('jb_key') || '';
let JSONBIN_BIN = localStorage.getItem('jb_bin') || '';
let _saveTimer  = null;

// Always save to localStorage immediately (works 100%)
function localSave(){
  try {
    localStorage.setItem('asist_state', JSON.stringify(state));
    localStorage.setItem('asist_pers',  JSON.stringify(personalizados));
  } catch(e){ console.warn('localStorage full', e); }
}

function localLoad(){
  try {
    const s = localStorage.getItem('asist_state');
    const p = localStorage.getItem('asist_pers');
    if(s) Object.assign(state, JSON.parse(s));
    if(p) personalizados = JSON.parse(p);
    return !!(s||p);
  } catch(e){ return false; }
}

function setSyncStatus(s, msg=''){
  const el = document.getElementById('syncIndicator'); if(!el) return;
  const map = {
    saving:       {icon:'ğŸ”„', text:'Guardando...',   color:'var(--yellow)'},
    saved:        {icon:'ğŸ’¾', text:'Guardado local',  color:'var(--green)'},
    cloudsaved:   {icon:'ğŸŸ¢', text:'En la nube',      color:'var(--green)'},
    error:        {icon:'ğŸ”´', text:msg||'Error',      color:'var(--red)'},
    unconfigured: {icon:'â˜ï¸', text:'Conectar nube',   color:'var(--muted)'},
    loading:      {icon:'ğŸ”„', text:'Cargando...',     color:'var(--yellow)'},
  };
  const m = map[s]||map.saving;
  const click = s==='unconfigured' ? "onclick='showCloudConfig()'" : "onclick='showCloudConfig()'";
  el.innerHTML = `<span style="color:${m.color};font-size:.75rem;display:flex;align-items:center;gap:4px;cursor:pointer" ${click} title="Configurar nube">${m.icon} ${m.text}</span>`;
}

function scheduleSync(){
  localSave(); // immediate local save
  setSyncStatus('saved');
  // Also try cloud if configured
  if(JSONBIN_KEY && JSONBIN_BIN){
    clearTimeout(_saveTimer);
    _saveTimer = setTimeout(cloudSave, 2500);
  }
}

function getPayload(){
  return { state, personalizados, savedAt: new Date().toISOString() };
}

// Use a CORS proxy to bypass JSONBin CORS restrictions
async function cloudSave(){
  if(!JSONBIN_KEY||!JSONBIN_BIN) return;
  try {
    // Try direct first
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN}`, {
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        'X-Master-Key':JSONBIN_KEY,
        'X-Bin-Versioning':'false'
      },
      body: JSON.stringify(getPayload())
    });
    if(res.ok){ setSyncStatus('cloudsaved'); return; }
    throw new Error(res.status);
  } catch(e){
    // Silently fail - local save already done
    console.warn('Cloud save failed, local save active:', e.message);
  }
}

async function cloudLoad(){
  if(!JSONBIN_KEY||!JSONBIN_BIN){ 
    // Load from localStorage instead
    const loaded = localLoad();
    if(loaded){
      refreshCurrentPage();
      showToast('ğŸ’¾ Datos cargados desde este dispositivo');
    }
    setSyncStatus('unconfigured');
    return; 
  }
  setSyncStatus('loading');
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN}/latest`,{
      headers:{'X-Master-Key':JSONBIN_KEY, 'X-Bin-Meta':'false'}
    });
    if(!res.ok) throw new Error(res.status);
    const json = await res.json();
    // JSONBin v3 returns record directly when X-Bin-Meta is false
    const data = json.record || json;
    if(data && data.state){
      Object.assign(state, data.state);
      if(data.personalizados) personalizados = data.personalizados;
      localSave(); // sync to local too
      refreshCurrentPage();
      setSyncStatus('cloudsaved');
      showToast('ğŸŸ¢ Datos cargados desde la nube');
    } else {
      // Cloud empty, use local
      localLoad();
      refreshCurrentPage();
      setSyncStatus('cloudsaved');
    }
  } catch(e){
    console.warn('Cloud load failed:', e);
    // Fallback to localStorage
    const loaded = localLoad();
    if(loaded){ refreshCurrentPage(); showToast('ğŸ’¾ Cargado desde este dispositivo (nube no disponible)'); }
    setSyncStatus('error', 'Nube no disponible');
  }
}

function refreshCurrentPage(){
  if(currentPage==='dashboard') renderDashboard();
  else if(currentPage==='personalizados') renderPersonalizados();
  else renderModule(currentPage);
}

async function cloudCreateBin(key){
  const res = await fetch('https://api.jsonbin.io/v3/b',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'X-Master-Key':key,
      'X-Bin-Name':'asistencias-redes-tics',
      'X-Bin-Private':'true'
    },
    body: JSON.stringify(getPayload())
  });
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    throw new Error(err.message||res.status);
  }
  const json = await res.json();
  return json.metadata.id;
}

function showCloudConfig(){
  const isConnected = !!(JSONBIN_KEY && JSONBIN_BIN);
  const html=`
  <div style="background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:.79rem;color:var(--muted);line-height:1.8;margin-bottom:12px;">
    <strong style="color:var(--text);display:block;margin-bottom:4px;">â˜ï¸ Guardar en la nube (JSONBin)</strong>
    1. Ve a <a href="https://jsonbin.io/login" target="_blank" style="color:var(--amber)">jsonbin.io</a> â†’ inicia sesiÃ³n<br>
    2. Panel izquierdo: <strong style="color:var(--text)">API Keys</strong> â†’ copia tu <strong style="color:var(--text)">Secret Key</strong><br>
    3. PÃ©gala abajo â†’ clic en <strong style="color:var(--text)">Conectar</strong>
    <div style="margin-top:8px;padding:8px;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);border-radius:6px;color:var(--green);font-size:.74rem;">
      ğŸ’¾ Mientras tanto, tus datos se guardan automÃ¡ticamente en <strong>este navegador</strong>. No perderÃ¡s nada.
    </div>
  </div>
  <div class="fgroup" style="margin-bottom:10px">
    <div class="flabel">Secret Key / Master Key</div>
    <input class="finp" id="jbKeyInp" placeholder="\$2a\$10\$..." value="${JSONBIN_KEY}" style="font-family:'JetBrains Mono',monospace;font-size:.74rem;">
  </div>
  <div class="fgroup">
    <div class="flabel">Bin ID (se crea solo si lo dejas vacÃ­o)</div>
    <input class="finp" id="jbBinInp" placeholder="6999c0a01a35bc..." value="${JSONBIN_BIN}" style="font-family:'JetBrains Mono',monospace;font-size:.74rem;">
  </div>
  ${isConnected ? `<div style="margin-top:10px;font-size:.75rem;color:var(--green);">ğŸŸ¢ Conectado â€” Bin: <code style="font-family:'JetBrains Mono',monospace">${JSONBIN_BIN}</code></div>` : ''}`;

  showModal('â˜ï¸ SincronizaciÃ³n en la nube','', async()=>{
    const key = document.getElementById('jbKeyInp')?.value.trim();
    const bin = document.getElementById('jbBinInp')?.value.trim();
    if(!key){ showToast('âš ï¸ Ingresa tu Secret Key'); return; }
    const okBtn = document.getElementById('mOk');
    okBtn.textContent='Conectando...'; okBtn.disabled=true;
    try {
      let binId = bin;
      if(!binId){
        showToast('ğŸ”„ Creando espacio en la nube...');
        binId = await cloudCreateBin(key);
        showToast(`âœ… Bin creado: ${binId}`);
      }
      JSONBIN_KEY=key; JSONBIN_BIN=binId;
      localStorage.setItem('jb_key',key);
      localStorage.setItem('jb_bin',binId);
      closeModal();
      showToast('âœ… Conectado. Subiendo datos...');
      await cloudSave();
      setSyncStatus('cloudsaved');
    } catch(e){
      console.error('Connect error:',e);
      showToast('âŒ Error al conectar. Verifica tu Secret Key en jsonbin.io â†’ API Keys');
      okBtn.textContent='Conectar'; okBtn.disabled=false;
    }
  }, html);

  document.getElementById('mOk').textContent = isConnected ? 'Actualizar' : 'Conectar';

  if(isConnected){
    setTimeout(()=>{
      const btns=document.querySelector('.modal-btns');
      if(!btns||document.getElementById('discBtn')) return;
      const b=document.createElement('button');
      b.id='discBtn'; b.className='btn btn-red'; b.textContent='Desconectar nube';
      b.onclick=()=>{
        JSONBIN_KEY=''; JSONBIN_BIN='';
        localStorage.removeItem('jb_key'); localStorage.removeItem('jb_bin');
        closeModal(); setSyncStatus('unconfigured');
        showToast('Desconectado. Datos siguen guardados en este dispositivo.');
      };
      btns.prepend(b);
    },60);
  }
}

// â”€â”€ INIT: Load data on startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initData(){
  if(JSONBIN_KEY && JSONBIN_BIN){
    cloudLoad(); // tries cloud, falls back to local
  } else {
    const loaded = localLoad();
    if(loaded){
      setTimeout(()=>{
        refreshCurrentPage();
        showToast('ğŸ’¾ Datos del dispositivo restaurados');
      }, 300);
    }
    setTimeout(()=>setSyncStatus('unconfigured'), 150);
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL / TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _modalCb=null;
function showModal(title,body,cb,extraHtml=''){
  document.getElementById('mTitle').textContent=title;
  document.getElementById('mBody').textContent=body;
  document.getElementById('mExtra').innerHTML=extraHtml;
  _modalCb=cb;
  document.getElementById('mOk').onclick=()=>{if(_modalCb)_modalCb();};
  document.getElementById('overlay').classList.add('show');
}
function closeModal(){ document.getElementById('overlay').classList.remove('show'); }

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

// Close modal on overlay click
document.getElementById('overlay').addEventListener('click',e=>{
  if(e.target===document.getElementById('overlay')) closeModal();
});

// â”€â”€ SIDEBAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  const isHidden=sb.classList.toggle('hidden');
  ov.classList.toggle('show',!isHidden);
}

// Auto-hide sidebar on small screens initially
function initSidebar(){
  if(window.innerWidth<900){
    document.getElementById('sidebar').classList.add('hidden');
  }
}
initSidebar();
window.addEventListener('resize',()=>{
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  if(window.innerWidth>=900){
    sb.classList.remove('hidden');
    ov.classList.remove('show');
  } else {
    sb.classList.add('hidden');
    ov.classList.remove('show');
  }
});
</script>
</body>
</html>
