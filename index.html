<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistencias â€” Redes & TICs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>

/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  /* Dark theme */
  --bg:       #070a10;
  --s1:       #0c1018;
  --s2:       #111520;
  --s3:       #181d2c;
  --s4:       #1e2438;
  --border:   #1c2234;
  --border2:  #242d45;

  --amber:    #f59e0b;
  --amber-g:  linear-gradient(135deg,#f59e0b,#f97316);
  --violet:   #7c3aed;
  --violet-l: #a78bfa;
  --rose:     #f43f5e;
  --teal:     #0d9488;
  --teal-l:   #2dd4bf;
  --sky:      #0284c7;
  --sky-l:    #38bdf8;

  --green:    #16a34a;
  --green-l:  #4ade80;
  --red:      #dc2626;
  --red-l:    #f87171;
  --yellow:   #ca8a04;
  --yellow-l: #fbbf24;
  --blue:     #2563eb;
  --blue-l:   #60a5fa;

  --text:     #e8edf8;
  --text2:    #a8b4cc;
  --muted:    #4a5568;
  --muted2:   #2d3748;

  --radius:   12px;
  --radius-sm:8px;
  --shadow:   0 4px 24px rgba(0,0,0,.4);
  --shadow-sm:0 2px 8px rgba(0,0,0,.3);
}

[data-theme="light"] {
  --bg:       #f0f4fc;
  --s1:       #ffffff;
  --s2:       #f5f7ff;
  --s3:       #eef1fb;
  --s4:       #e4e9f7;
  --border:   #dce3f0;
  --border2:  #c8d2e8;

  --text:     #0f172a;
  --text2:    #475569;
  --muted:    #94a3b8;
  --muted2:   #cbd5e1;

  --shadow:   0 4px 24px rgba(15,23,42,.08);
  --shadow-sm:0 2px 8px rgba(15,23,42,.06);
}

/* â”€â”€ BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;}

body{
  background:var(--bg);color:var(--text);
  font-family:'Sora',sans-serif;min-height:100vh;
  transition:background .3s,color .3s;
}

[data-theme="dark"] body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 70% 50% at 10% -10%, rgba(124,58,237,.08) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 90% 110%, rgba(245,158,11,.06) 0%, transparent 60%);
}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{display:flex;min-height:100vh;position:relative;z-index:1;}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{
  width:252px;flex-shrink:0;
  background:var(--s1);border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  position:fixed;top:0;left:0;height:100vh;overflow-y:auto;
  scrollbar-width:thin;scrollbar-color:var(--border2) transparent;
  z-index:200;transition:transform .28s cubic-bezier(.4,0,.2,1);
}
.sidebar.hidden{transform:translateX(-100%);}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199;backdrop-filter:blur(2px);}
.sidebar-overlay.show{display:block;}
.content{margin-left:252px;transition:margin-left .28s cubic-bezier(.4,0,.2,1);min-height:100vh;display:flex;flex-direction:column;}
.sidebar.hidden ~ .content{margin-left:0;}

.sidebar-logo{
  padding:24px 20px 18px;border-bottom:1px solid var(--border);
}
.sidebar-logo .logo-mark{
  font-size:1.2rem;font-weight:800;letter-spacing:-0.8px;
  background:var(--amber-g);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.sidebar-logo small{display:block;font-size:.68rem;font-weight:400;color:var(--muted);margin-top:3px;letter-spacing:.3px;}

.nav-section{padding:12px 10px 4px;}
.nav-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.4px;color:var(--muted);padding:0 10px;margin-bottom:5px;}

.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:var(--radius-sm);
  font-size:.82rem;font-weight:500;color:var(--text2);
  cursor:pointer;transition:all .15s;border:none;background:transparent;width:100%;text-align:left;
}
.nav-item:hover{background:var(--s3);color:var(--text);}
.nav-item.active{
  background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(124,58,237,.1));
  color:var(--text);font-weight:600;
  border-left:2px solid var(--amber);padding-left:8px;
}
.nav-item .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dot.amber{background:var(--amber);}
.dot.violet{background:var(--violet-l);}
.dot.teal{background:var(--teal-l);}
.dot.rose{background:var(--rose);}
.dot.sky{background:var(--sky-l);}
.nav-mod{padding-left:26px;font-size:.79rem;}
.nav-mod .dot{width:5px;height:5px;}
.nav-sub-label{font-size:.66rem;font-weight:600;text-transform:uppercase;letter-spacing:.9px;color:var(--muted2);padding:6px 18px 2px;display:block;}
.sidebar-footer{margin-top:auto;padding:14px 12px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px;}

/* theme toggle */
.theme-toggle{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--radius-sm);
  font-size:.78rem;color:var(--text2);cursor:pointer;border:1px solid var(--border);
  background:var(--s2);transition:all .15s;width:100%;
}
.theme-toggle:hover{border-color:var(--amber);color:var(--text);}
.toggle-track{
  width:32px;height:18px;background:var(--s4);border-radius:9px;
  position:relative;transition:background .25s;margin-left:auto;flex-shrink:0;
}
[data-theme="light"] .toggle-track{background:var(--amber);}
.toggle-thumb{
  width:12px;height:12px;background:var(--muted);border-radius:50%;
  position:absolute;top:3px;left:3px;transition:all .25s;
}
[data-theme="light"] .toggle-thumb{transform:translateX(14px);background:#fff;}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{
  padding:14px 28px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
  background:rgba(7,10,16,.92);backdrop-filter:blur(16px);
  position:sticky;top:0;z-index:100;
}
[data-theme="light"] .topbar{background:rgba(240,244,252,.92);}
.topbar-title{font-size:.95rem;font-weight:700;flex:1;min-width:0;}
.topbar-date{font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}

/* global search */
.global-search-wrap{position:relative;flex:1;max-width:260px;}
.global-search-wrap .inp{width:100%;padding-left:30px;font-size:.8rem;}
.global-search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.8rem;pointer-events:none;}
#globalResults{
  position:absolute;top:calc(100% + 6px);left:0;right:0;
  background:var(--s1);border:1px solid var(--border2);border-radius:var(--radius);
  z-index:500;max-height:320px;overflow-y:auto;
  box-shadow:var(--shadow);display:none;
}
#globalResults.show{display:block;}
.gr-item{
  padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);
  transition:background .12s;
}
.gr-item:last-child{border-bottom:none;}
.gr-item:hover{background:var(--s3);}
.gr-item .gr-name{font-size:.83rem;font-weight:600;}
.gr-item .gr-sub{font-size:.72rem;color:var(--muted);margin-top:2px;}
.gr-empty{padding:16px;text-align:center;font-size:.8rem;color:var(--muted);}

/* â”€â”€ PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{padding:24px 28px;display:none;flex:1;}
.page.active{display:block;}

/* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;}
.stat{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px 18px;transition:transform .18s,border-color .18s;
}
.stat:hover{transform:translateY(-2px);border-color:var(--border2);}
.stat .v{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:600;line-height:1;margin-bottom:5px;}
.stat .l{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;}
.v.green{color:var(--green-l);} .v.red{color:var(--red-l);}
.v.yellow{color:var(--yellow-l);} .v.amber{color:var(--amber);} .v.blue{color:var(--blue-l);}

/* â”€â”€ INPUTS / BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.inp{
  background:var(--s2);border:1px solid var(--border);border-radius:var(--radius-sm);
  color:var(--text);font-family:'Sora',sans-serif;font-size:.82rem;
  padding:7px 11px;outline:none;transition:border-color .2s,box-shadow .2s;
}
.inp:focus{border-color:var(--amber);box-shadow:0 0 0 3px rgba(245,158,11,.12);}
.inp[type=date]::-webkit-calendar-picker-indicator{filter:invert(.5);cursor:pointer;}
.search-w{position:relative;}
.search-w .inp{padding-left:28px;}
.search-ico{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.8rem;pointer-events:none;}
.thr-wrap{display:flex;align-items:center;gap:5px;font-size:.77rem;color:var(--muted);}
select.inp{cursor:pointer;}

.btn{
  padding:7px 14px;border-radius:var(--radius-sm);border:none;cursor:pointer;
  font-family:'Sora',sans-serif;font-weight:700;font-size:.78rem;
  transition:all .18s;white-space:nowrap;
}
.btn-amber{background:var(--amber-g);color:#000;box-shadow:0 2px 8px rgba(245,158,11,.3);}
.btn-amber:hover{opacity:.88;transform:translateY(-1px);}
.btn-green{background:linear-gradient(135deg,var(--green),var(--teal));color:#fff;}
.btn-green:hover{opacity:.88;transform:translateY(-1px);}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.btn-outline:hover{border-color:var(--amber);color:var(--amber);}
.btn-red{background:rgba(220,38,38,.12);border:1px solid rgba(220,38,38,.25);color:var(--red-l);}
.btn-red:hover{background:rgba(220,38,38,.22);}
.btn-violet{background:linear-gradient(135deg,var(--violet),#6d28d9);color:#fff;}
.btn-violet:hover{opacity:.88;}
.btn-teal{background:linear-gradient(135deg,var(--teal),var(--sky));color:#fff;}
.btn-teal:hover{opacity:.88;}

/* â”€â”€ ALERT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-bar{
  background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.18);
  border-radius:10px;padding:10px 14px;margin-bottom:14px;
  font-size:.82rem;color:var(--red-l);display:none;gap:8px;line-height:1.5;align-items:flex-start;
}
.alert-bar.show{display:flex;}

/* â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.toolbar-h{font-weight:700;font-size:.9rem;flex:1;}

/* â”€â”€ DATE SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.date-selector-bar{
  background:linear-gradient(135deg,rgba(245,158,11,.06),rgba(124,58,237,.04));
  border:1px solid rgba(245,158,11,.15);border-radius:var(--radius);
  padding:12px 16px;margin-bottom:16px;
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
}
.date-selector-label{font-size:.78rem;font-weight:600;color:var(--text2);}
.date-selector-controls{display:flex;align-items:center;gap:6px;}
.date-quick-btn{
  padding:5px 12px;border-radius:20px;border:1px solid var(--border2);
  background:var(--s2);color:var(--text2);font-family:'Sora',sans-serif;
  font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s;
}
.date-quick-btn:hover,.date-quick-btn.active{background:var(--amber);color:#000;border-color:var(--amber);}
.date-inp-main{
  background:var(--s2);border:1px solid var(--border2);border-radius:var(--radius-sm);
  color:var(--text);font-family:'Sora',sans-serif;font-size:.8rem;
  padding:5px 9px;outline:none;transition:border-color .2s;
}
.date-inp-main:focus{border-color:var(--amber);}
.date-inp-main::-webkit-calendar-picker-indicator{filter:invert(.5);cursor:pointer;}
.date-selector-info{
  font-size:.75rem;font-weight:600;padding:4px 10px;border-radius:20px;margin-left:auto;
}
.date-selector-info.hoy{background:rgba(74,222,128,.12);color:var(--green-l);border:1px solid rgba(74,222,128,.2);}
.date-selector-info.pasado{background:rgba(167,139,250,.12);color:var(--violet-l);border:1px solid rgba(167,139,250,.2);}

/* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm);}
table{width:100%;border-collapse:collapse;}
thead{background:var(--s2);}
th{
  padding:11px 14px;text-align:left;
  font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;
  color:var(--muted);border-bottom:1px solid var(--border);
}
td{padding:10px 14px;border-bottom:1px solid rgba(28,34,52,.6);font-size:.84rem;vertical-align:middle;}
[data-theme="light"] td{border-bottom-color:rgba(220,227,240,.8);}
tr:last-child td{border-bottom:none;}
tr{transition:background .12s;}
tr:hover td{background:rgba(245,158,11,.025);}
.aname{font-weight:600;font-size:.84rem;}
.asub{font-size:.7rem;color:var(--muted);margin-top:2px;}

/* â”€â”€ ATTENDANCE BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ab-group{display:flex;gap:4px;}
.ab{
  padding:5px 10px;border-radius:6px;border:1.5px solid var(--border2);
  background:var(--s3);color:var(--text2);font-family:'JetBrains Mono',monospace;
  font-size:.76rem;font-weight:600;cursor:pointer;transition:all .15s;
  position:relative;
}
.ab:hover{border-color:var(--border2);background:var(--s4);}
.ab.presente{background:rgba(22,163,74,.18);border-color:rgba(74,222,128,.4);color:var(--green-l);}
.ab.falta{background:rgba(220,38,38,.18);border-color:rgba(248,113,113,.4);color:var(--red-l);}
.ab.permiso{background:rgba(37,99,235,.18);border-color:rgba(96,165,250,.4);color:var(--blue-l);}
.ab.has-motivo::after{content:'â—';font-size:.5rem;position:absolute;top:2px;right:2px;color:var(--amber);}

/* â”€â”€ HISTORY PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hist-pills{display:flex;gap:3px;flex-wrap:wrap;}
.hp{
  width:18px;height:18px;border-radius:4px;font-size:.6rem;font-weight:700;
  font-family:'JetBrains Mono',monospace;display:flex;align-items:center;justify-content:center;
}
.hp.P{background:rgba(22,163,74,.25);color:var(--green-l);}
.hp.F{background:rgba(220,38,38,.25);color:var(--red-l);}
.hp.Pm{background:rgba(37,99,235,.25);color:var(--blue-l);}
.hp.x{background:var(--s3);color:var(--muted2);}

/* â”€â”€ PERCENT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pct-bar{display:flex;align-items:center;gap:7px;}
.pct-track{flex:1;height:5px;background:var(--s4);border-radius:3px;min-width:50px;}
.pct-fill{height:100%;border-radius:3px;transition:width .4s ease;}
.pct-label{font-size:.75rem;font-family:'JetBrains Mono',monospace;font-weight:600;min-width:32px;text-align:right;}

/* â”€â”€ RETIRAR BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-retirar{
  padding:4px 9px;border-radius:6px;font-size:.7rem;font-weight:600;
  border:1px solid rgba(244,63,94,.25);background:rgba(244,63,94,.08);
  color:var(--rose);cursor:pointer;transition:all .15s;font-family:'Sora',sans-serif;
}
.btn-retirar:hover{background:rgba(244,63,94,.18);border-color:rgba(244,63,94,.4);}
.btn-reactivar{
  padding:4px 9px;border-radius:6px;font-size:.7rem;font-weight:600;
  border:1px solid rgba(74,222,128,.25);background:rgba(74,222,128,.08);
  color:var(--green-l);cursor:pointer;transition:all .15s;font-family:'Sora',sans-serif;
}
.btn-reactivar:hover{background:rgba(74,222,128,.18);}

/* â”€â”€ PANELS / FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px 22px;margin-bottom:16px;box-shadow:var(--shadow-sm);
}
.panel-title{
  font-size:.85rem;font-weight:700;margin-bottom:14px;
  display:flex;align-items:center;gap:8px;
}
.panel-title span{color:var(--text2);}
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.fgroup{display:flex;flex-direction:column;gap:5px;}
.flabel{font-size:.72rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.finp{
  background:var(--s2);border:1px solid var(--border);border-radius:var(--radius-sm);
  color:var(--text);font-family:'Sora',sans-serif;font-size:.83rem;
  padding:8px 10px;outline:none;transition:border-color .2s,box-shadow .2s;width:100%;
}
.finp:focus{border-color:var(--amber);box-shadow:0 0 0 3px rgba(245,158,11,.1);}
.form-actions{margin-top:14px;display:flex;gap:8px;}

/* â”€â”€ RETIRADOS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.retirados-section{margin-top:20px;}
.retirados-toggle{
  display:flex;align-items:center;gap:8px;padding:10px 14px;
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  cursor:pointer;font-size:.82rem;font-weight:600;color:var(--text2);
  transition:all .15s;margin-bottom:8px;
}
.retirados-toggle:hover{border-color:var(--border2);color:var(--text);}
.retirados-badge{
  font-size:.68rem;padding:2px 8px;border-radius:10px;
  background:rgba(244,63,94,.12);color:var(--rose);margin-left:auto;
}

/* â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-wrap{background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-top:16px;}
.chart-title{font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px;}
.chart-bars{display:flex;align-items:flex-end;gap:6px;height:60px;}
.chart-bar-wrap{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;min-width:0;}
.chart-bar{width:100%;border-radius:4px 4px 0 0;transition:height .4s ease;min-height:4px;}
.chart-label{font-size:.58rem;color:var(--muted);font-family:'JetBrains Mono',monospace;text-align:center;}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  background:var(--s1);border:1px solid var(--border2);border-radius:10px;
  padding:11px 18px;font-size:.83rem;font-weight:500;
  box-shadow:var(--shadow);
  transform:translateY(20px);opacity:0;transition:all .3s cubic-bezier(.4,0,.2,1);
  pointer-events:none;max-width:320px;
}
.toast.show{transform:translateY(0);opacity:1;}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:300;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.overlay.show{display:flex;}
.modal{
  background:var(--s1);border:1px solid var(--border2);border-radius:18px;
  padding:0;width:100%;max-width:480px;max-height:90vh;
  display:flex;flex-direction:column;overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  animation:modalIn .22s ease;
}
@keyframes modalIn{from{transform:scale(.95) translateY(8px);opacity:0;}to{transform:none;opacity:1;}}
.modal h3{font-size:1rem;font-weight:700;padding:24px 24px 0;}
.modal p{color:var(--text2);font-size:.83rem;line-height:1.6;padding:8px 24px 0;}
.modal-body-scroll{flex:1;overflow-y:auto;padding:8px 24px 12px;}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;padding:14px 24px;border-top:1px solid var(--border);flex-shrink:0;}

/* â”€â”€ MOTIVO FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.motivo-grid{display:flex;flex-direction:column;gap:12px;margin-top:8px;}
.foto-preview{
  width:100%;height:110px;border-radius:var(--radius-sm);
  border:2px dashed var(--border2);display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--muted);font-size:.78rem;gap:8px;
  background:var(--s2);transition:border-color .2s;overflow:hidden;
}
.foto-preview:hover{border-color:var(--amber);}
.foto-preview img{width:100%;height:100%;object-fit:cover;border-radius:6px;}

/* â”€â”€ HISTORIAL DE CAMBIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.historial-section{margin-top:20px;}
.historial-wrap{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;max-height:220px;overflow-y:auto;
}
.historial-item{
  display:flex;align-items:flex-start;gap:10px;
  padding:10px 14px;border-bottom:1px solid var(--border);
  font-size:.78rem;transition:background .12s;
  animation:fadeIn .25s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateX(-6px);}to{opacity:1;transform:none;}}
.historial-item:last-child{border-bottom:none;}
.historial-item:hover{background:var(--s2);}
.hi-icon{font-size:.9rem;flex-shrink:0;margin-top:1px;}
.hi-body{flex:1;min-width:0;}
.hi-text{color:var(--text2);line-height:1.4;}
.hi-time{font-size:.68rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.historial-empty{padding:16px;text-align:center;font-size:.8rem;color:var(--muted);}

/* â”€â”€ RESUMEN MENSUAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monthly-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:8px;}
.monthly-card{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px 16px;transition:transform .18s,border-color .18s;
}
.monthly-card:hover{transform:translateY(-2px);border-color:var(--border2);}
.mc-name{font-size:.83rem;font-weight:700;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mc-stats{display:flex;gap:10px;font-size:.7rem;color:var(--muted);margin-bottom:8px;}
.mc-bar-track{height:6px;background:var(--s4);border-radius:3px;overflow:hidden;}
.mc-bar-fill{height:100%;border-radius:3px;transition:width .5s ease;}
.mc-pct{font-size:.8rem;font-family:'JetBrains Mono',monospace;font-weight:700;margin-top:4px;}

/* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dash-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:20px;}
.dash-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);}
.dash-card h4{font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:14px;}
.dash-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);}
.dash-row:last-child{border-bottom:none;}
.dash-row .dr-name{font-size:.82rem;}
.dash-row .dr-pct{font-size:.78rem;font-family:'JetBrains Mono',monospace;font-weight:700;}

/* â”€â”€ HAMBURGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hamburger{
  display:flex;align-items:center;justify-content:center;
  width:36px;height:36px;border-radius:var(--radius-sm);border:1px solid var(--border);
  background:var(--s2);cursor:pointer;flex-shrink:0;font-size:1rem;transition:all .15s;
}
.hamburger:hover{border-color:var(--amber);color:var(--amber);}


/* â”€â”€ NOTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notas-tema{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  margin-bottom:12px;overflow:hidden;box-shadow:var(--shadow-sm);
}
.notas-tema-header{
  display:flex;align-items:center;gap:10px;padding:12px 16px;
  background:var(--s2);border-bottom:1px solid var(--border);cursor:pointer;
  user-select:none;transition:background .15s;
}
.notas-tema-header:hover{background:var(--s3);}
.notas-tema-title{font-size:.85rem;font-weight:700;flex:1;}
.notas-tema-stats{display:flex;gap:12px;font-size:.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.notas-tema-badge{
  font-size:.68rem;font-weight:700;padding:2px 10px;border-radius:20px;
  background:rgba(124,58,237,.15);color:var(--violet-l);border:1px solid rgba(124,58,237,.25);
}
.notas-table-wrap{overflow:hidden;}
.nota-inp{
  width:80px;background:var(--s2);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.83rem;
  padding:5px 8px;outline:none;transition:border-color .2s,box-shadow .2s;text-align:center;
}
.nota-inp:focus{border-color:var(--violet-l);box-shadow:0 0 0 3px rgba(124,58,237,.12);}
.nota-badge{
  display:inline-block;font-size:.68rem;font-weight:700;padding:2px 8px;border-radius:10px;
  font-family:'JetBrains Mono',monospace;
}
.nota-badge.ap{background:rgba(22,163,74,.15);color:var(--green-l);}
.nota-badge.des{background:rgba(220,38,38,.15);color:var(--red-l);}
.nota-badge.vacio{background:var(--s3);color:var(--muted);}

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:900px){
  .content{margin-left:0!important;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .dash-grid{grid-template-columns:1fr;}
  .global-search-wrap{max-width:100%;flex:auto;}
}
@media(max-width:600px){
  .page{padding:14px 16px;}
  .topbar{padding:10px 14px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<div class="layout">

<!-- â•â• SIDEBAR OVERLAY â•â• -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">Redes &amp; TICs</div>
    <small>Sistema de Asistencias</small>
  </div>

  <div class="nav-section">
    <div class="nav-label">General</div>
    <button class="nav-item active" onclick="goPage('dashboard')">
      <div class="dot sky"></div> Resumen General
    </button>
    <button class="nav-item" onclick="goPage('mensual')">
      <div class="dot teal"></div> Resumen Mensual
    </button>
    <button class="nav-item" onclick="goPage('historial')">
      <div class="dot rose"></div> Historial de Cambios
    </button>
  </div>

  <div class="nav-section">
    <div class="nav-label">â˜€ï¸ Turno MaÃ±ana</div>
    <button class="nav-item nav-mod" onclick="goPage('M-1')"><div class="dot amber"></div>MÃ³dulo 1</button>
    <button class="nav-item nav-mod" onclick="goPage('M-2')"><div class="dot amber"></div>MÃ³dulo 2</button>
    <button class="nav-item nav-mod" onclick="goPage('M-3')"><div class="dot amber"></div>MÃ³dulo 3</button>
    <button class="nav-item nav-mod" onclick="goPage('M-4')"><div class="dot amber"></div>MÃ³dulo 4</button>
  </div>

  <div class="nav-section">
    <div class="nav-label">ğŸŒ™ Turno Tarde</div>
    <button class="nav-item nav-mod" onclick="goPage('T-1')"><div class="dot violet"></div>MÃ³dulo 1</button>
    <button class="nav-item nav-mod" onclick="goPage('T-2')"><div class="dot violet"></div>MÃ³dulo 2</button>
    <button class="nav-item nav-mod" onclick="goPage('T-3')"><div class="dot violet"></div>MÃ³dulo 3</button>
    <button class="nav-item nav-mod" onclick="goPage('T-4')"><div class="dot violet"></div>MÃ³dulo 4</button>
  </div>

  <div class="nav-section">
    <div class="nav-label">Individual</div>
    <button class="nav-item" onclick="goPage('personalizados')">
      <div class="dot teal"></div> Clases Personalizadas
    </button>
  </div>

  <div class="sidebar-footer">
    <button class="btn btn-green" style="width:100%" onclick="exportarTodo()">â¬‡ï¸ Exportar Excel</button>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">
      <span id="themeLabel">ğŸŒ™ Modo oscuro</span>
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
    </button>
  </div>
</nav>

<!-- â•â• CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="content">
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()" title="MenÃº">â˜°</button>
    <div class="topbar-title" id="topbarTitle">Resumen General</div>
    <!-- Global Search -->
    <div class="global-search-wrap">
      <span class="global-search-icon">ğŸ”</span>
      <input class="inp" id="globalSearchInput" placeholder="Buscar alumno en todos los mÃ³dulos..." oninput="globalSearch(this.value)" onblur="setTimeout(()=>closeGlobalSearch(),200)">
      <div id="globalResults"></div>
    </div>
    <div id="syncIndicator"></div>
    <button class="btn btn-outline" style="font-size:.72rem;padding:5px 10px" onclick="showCloudConfig()" title="Configurar Google Sheets">â˜ï¸ Sheets</button>
    <div class="topbar-date" id="topbarDate"></div>
  </div>

  <!-- â”€â”€ DASHBOARD â”€â”€ -->
  <div class="page active" id="page-dashboard">
    <div class="stats-grid">
      <div class="stat"><div class="v amber" id="d-total">0</div><div class="l">Alumnos totales</div></div>
      <div class="stat"><div class="v green"  id="d-pres">0</div><div class="l">Presentes hoy</div></div>
      <div class="stat"><div class="v red"    id="d-falt">0</div><div class="l">Faltas hoy</div></div>
      <div class="stat"><div class="v yellow" id="d-alert">0</div><div class="l">Con alertas</div></div>
      <div class="stat"><div class="v blue"   id="d-pers">0</div><div class="l">Personalizados</div></div>
    </div>
    <div class="dash-grid" id="dashCards"></div>
  </div>

  <!-- â”€â”€ RESUMEN MENSUAL â”€â”€ -->
  <div class="page" id="page-mensual">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap;">
      <h2 style="font-size:1rem;font-weight:700;">ğŸ“… Resumen Mensual</h2>
      <select class="inp" id="mensualKey" onchange="renderMensual()" style="min-width:160px;">
        <option value="M-1">MaÃ±ana M1</option>
        <option value="M-2">MaÃ±ana M2</option>
        <option value="M-3">MaÃ±ana M3</option>
        <option value="M-4">MaÃ±ana M4</option>
        <option value="T-1">Tarde M1</option>
        <option value="T-2">Tarde M2</option>
        <option value="T-3">Tarde M3</option>
        <option value="T-4">Tarde M4</option>
      </select>
      <input type="month" class="inp" id="mensualMes" onchange="renderMensual()">
    </div>
    <div id="mensualContent"></div>
  </div>

  <!-- â”€â”€ HISTORIAL DE CAMBIOS â”€â”€ -->
  <div class="page" id="page-historial">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap;">
      <h2 style="font-size:1rem;font-weight:700;">ğŸ•’ Historial de Cambios</h2>
      <button class="btn btn-outline" style="font-size:.72rem;margin-left:auto;" onclick="clearHistorial()">ğŸ—‘ Limpiar historial</button>
    </div>
    <div id="historialFullList"></div>
  </div>

  <!-- â”€â”€ MÃ“DULOS (se generan dinÃ¡micamente) â”€â”€ -->

  <!-- â”€â”€ PERSONALIZADOS â”€â”€ -->
  <div class="page" id="page-personalizados">
    <div class="panel">
      <div class="panel-title">â• <span>Agregar alumno personalizado</span></div>
      <div class="form-grid">
        <div class="fgroup"><div class="flabel">Apellidos y Nombres *</div><input class="finp" id="pNombre" placeholder="Ej: GarcÃ­a LÃ³pez Ana"></div>
        <div class="fgroup"><div class="flabel">DNI</div><input class="finp" id="pDni" placeholder="12345678" maxlength="8"></div>
        <div class="fgroup"><div class="flabel">Fecha de nacimiento</div><input class="finp" type="date" id="pFecha"></div>
        <div class="fgroup"><div class="flabel">Edad</div><input class="finp" id="pEdad" placeholder="25" type="number" min="1" max="99" style="width:80px"></div>
        <div class="fgroup"><div class="flabel">Correo electrÃ³nico</div><input class="finp" id="pCorreo" placeholder="correo@gmail.com" type="email"></div>
        <div class="fgroup"><div class="flabel">Celular</div><input class="finp" id="pTel" placeholder="999 999 999"></div>
        <div class="fgroup"><div class="flabel">Tema / Materia</div><input class="finp" id="pTema" placeholder="Ej: Excel bÃ¡sico"></div>
        <div class="fgroup"><div class="flabel">Horario / DÃ­a</div><input class="finp" id="pHorario" placeholder="Ej: SÃ¡bados 10am"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-amber" onclick="agregarPersonalizado()">Agregar alumno</button>
      </div>
    </div>
    <div class="toolbar">
      <div class="toolbar-h">Alumnos Personalizados</div>
      <div class="search-w">
        <span class="search-ico">ğŸ”</span>
        <input class="inp" id="persSearch" placeholder="Buscar..." oninput="renderPersonalizados()" style="padding-left:28px;width:170px;">
      </div>
    </div>
    <div id="persList"></div>
  </div>

</div><!-- /content -->
</div><!-- /layout -->

<div class="toast" id="toast"></div>

<div class="overlay" id="overlay">
  <div class="modal" id="modalBox">
    <h3 id="mTitle"></h3>
    <div class="modal-body-scroll">
      <p id="mBody"></p>
      <div id="mExtra"></div>
    </div>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-amber" id="mOk">Confirmar</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  state[key] = { alumnos:[{id,nombre}], asistencias:{id:{fecha:val}}, fechas:[] }
  keys: 'M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'

  personalizados:[{id,nombre,tel,tema,horario,clases:[{fecha,val}]}]
*/
let state = {};
let personalizados = [];
let currentPage = 'dashboard';
const today = new Date().toISOString().split('T')[0];

const TURNOS = {
  'M':{ label:'Turno MaÃ±ana', cls:'manana', color:'var(--amber)' },
  'T':{ label:'Turno Tarde',  cls:'tarde',  color:'var(--violet)' }
};
const MOD_NAMES = ['','MÃ³dulo 1','MÃ³dulo 2','MÃ³dulo 3','MÃ³dulo 4'];

// Init all module states empty
['M','T'].forEach(t=>[1,2,3,4].forEach(m=>{
  state[`${t}-${m}`] = { alumnos:[], retirados:[], asistencias:{}, fechas:[], motivos:{} };
}));

// â”€â”€ Init UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('topbarDate').textContent =
  new Date().toLocaleDateString('es',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

// Build module pages
['M','T'].forEach(t=>[1,2,3,4].forEach(m=>{
  const key = `${t}-${m}`;
  const div = document.createElement('div');
  div.className = 'page';
  div.id = `page-${key}`;
  div.innerHTML = buildModulePage(key);
  document.querySelector('.content').appendChild(div);
}));

renderDashboard();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));

  document.getElementById(`page-${id}`)?.classList.add('active');

  document.querySelectorAll('.nav-item').forEach(n=>{
    if(n.getAttribute('onclick')===`goPage('${id}')`) n.classList.add('active');
  });

  currentPage = id;

  let title = 'Resumen General';
  if(id==='personalizados') title = 'ğŸ‘¤ Clases Personalizadas';
  else if(id==='mensual') title = 'ğŸ“… Resumen Mensual';
  else if(id==='historial') title = 'ğŸ•’ Historial de Cambios';
  else if(id.includes('-')){
    const [t,m] = id.split('-');
    title = `${TURNOS[t].label} â€” MÃ³dulo ${m}`;
  }
  document.getElementById('topbarTitle').textContent = title;

  if(window.innerWidth<900){
    document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('sidebarOverlay').classList.remove('show');
  }

  if(id==='dashboard') renderDashboard();
  else if(id==='personalizados') renderPersonalizados();
  else if(id==='mensual'){
    const mi=document.getElementById('mensualMes');
    if(mi&&!mi.value) mi.value=today.slice(0,7);
    renderMensual();
  }
  else if(id==='historial') renderHistorialMini();
  else { renderModule(id); setTimeout(()=>initDateBar(id), 50); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD MODULE PAGE HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildModulePage(key){
  const [t,m] = key.split('-');
  const turno = TURNOS[t];
  return `
  <div class="mod-header">
    <span class="mod-badge ${turno.cls}">${turno.label}</span>
    <div class="mod-info">MÃ³dulo <strong>${m}</strong></div>
  </div>

  <!-- IMPORT PANEL -->
  <div class="panel" id="importPanel-${key}">
    <div class="panel-title">ğŸ“‚ <span>Importar desde Excel o cargar manualmente</span></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <label class="btn btn-amber" for="fileInput-${key}" style="cursor:pointer;">ğŸ“‚ Subir Excel de este mÃ³dulo</label>
      <input type="file" id="fileInput-${key}" accept=".xlsx,.xls" style="display:none" onchange="importExcel('${key}',this)">
      <button class="btn btn-outline" onclick="showAddAlumnoModal('${key}')">â• Agregar alumno manualmente</button>
    </div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:10px;line-height:1.7;">
      El Excel debe tener: <strong>Fila 1</strong> = fechas Â· <strong>Fila 2</strong> = nÃºmero de clase Â· <strong>Fila 3+</strong> = alumnos con valores <em>Presente / Falta / Permiso</em>. La Ãºltima fila con fÃ³rmulas se omite automÃ¡ticamente.
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
    <div class="stat"><div class="v green"  id="st-pres-${key}">0</div><div class="l">Presentes hoy</div></div>
    <div class="stat"><div class="v red"    id="st-falt-${key}">0</div><div class="l">Faltas hoy</div></div>
    <div class="stat"><div class="v blue"   id="st-perm-${key}">0</div><div class="l">Permisos hoy</div></div>
    <div class="stat"><div class="v yellow" id="st-alert-${key}">0</div><div class="l">Con alertas</div></div>
  </div>

  <div class="alert-bar" id="alertBar-${key}">âš ï¸ <span id="alertTxt-${key}"></span></div>

  <!-- SELECTOR DE FECHA â€” destacado -->
  <div class="date-selector-bar" id="datebar-${key}">
    <div class="date-selector-label">ğŸ“… Registrando asistencia del dÃ­a:</div>
    <div class="date-selector-controls">
      <button class="date-quick-btn" id="btnHoy-${key}" onclick="setDateQuick('${key}','hoy')">Hoy</button>
      <button class="date-quick-btn" id="btnAyer-${key}" onclick="setDateQuick('${key}','ayer')">Ayer</button>
      <input type="date" class="date-inp-main" id="date-${key}" value="${today}" onchange="onDateChange('${key}')">
    </div>
    <div class="date-selector-info" id="dateInfo-${key}"></div>
  </div>

  <div class="toolbar">
    <div class="toolbar-h" id="modTitle-${key}">â€” alumnos</div>
    <div class="search-w">
      <span class="search-ico">ğŸ”</span>
      <input class="inp" id="search-${key}" placeholder="Buscar..." oninput="renderModule('${key}')" style="padding-left:28px;width:165px;">
    </div>
    <div class="thr-wrap">âš ï¸ Alerta
      <select class="inp" id="thr-${key}" onchange="renderModule('${key}')">
        <option value="2">2 faltas</option>
        <option value="3" selected>3 faltas</option>
        <option value="4">4 faltas</option>
        <option value="5">5 faltas</option>
      </select>
    </div>
    <button class="btn btn-amber" onclick="marcarTodos('${key}','Presente')">âœ… Todos presentes</button>
    <button class="btn btn-outline" onclick="showAddAlumnoModal('${key}')">â• Alumno</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead><tr>
        <th>#</th><th>Alumno</th><th id="th-asist-${key}">Asistencia hoy</th>
        <th>Historial</th><th>% Asistencia</th><th></th>
      </tr></thead>
      <tbody id="tbody-${key}"></tbody>
    </table>
  </div>
  <!-- GrÃ¡fica -->
  <div class="chart-wrap" style="margin-top:16px">
    <div class="chart-title">ğŸ“Š Asistencia por fecha â€” Ãºltimas 10 clases</div>
    <div id="chart-${key}"><div style="color:var(--muted);font-size:.78rem;text-align:center;padding:16px">Sin datos aÃºn</div></div>
  </div>
  <!-- Retirados -->
  <div id="retirados-section-${key}" style="display:none;margin-top:4px"></div>

  <!-- NOTAS -->
  <div style="margin-top:20px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div style="font-size:.85rem;font-weight:700;">ğŸ“ Notas</div>
      <button class="btn btn-violet" onclick="showAddNotaModal('${key}')">ï¼‹ Nuevo tema</button>
    </div>
    <div id="notas-section-${key}"></div>
  </div>`;

}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importExcel(key, input){
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result,{type:'binary',cellDates:true});
    // Try to find the right sheet, or just use first
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    const result = parseSheet(rows);
    if(!result){ showToast('âŒ No se pudieron leer los datos del archivo.'); return; }
    state[key] = result;
    renderModule(key);
    showToast(`âœ… ${result.alumnos.length} alumnos importados en ${key.replace('-',' MÃ³dulo ')}`);
    input.value='';
  };
  reader.readAsBinaryString(file);
}

function parseSheet(rows){
  if(!rows||rows.length<3) return null;
  const dateRow = rows[0];
  const dateColMap={};
  for(let c=1;c<dateRow.length;c++){
    const cell=dateRow[c];
    let d=null;
    if(cell instanceof Date) d=cell.toISOString().split('T')[0];
    else if(cell!==''&&cell!==null) d=normalizeDate(String(cell).trim());
    if(d) dateColMap[c]=d;
  }
  const fechas=[...new Set(Object.values(dateColMap))].sort();
  const alumnos=[],asistencias={};
  for(let r=2;r<rows.length;r++){
    const row=rows[r];
    const nombre=String(row[0]||'').trim();
    if(!nombre||nombre.length<2) continue;
    const low=nombre.toLowerCase();
    if(low.includes('total')||low.includes('nombre')||low.includes('alumno')||/^[=]/.test(nombre)) continue;
    // Skip formula rows
    if(String(row[1]||'').startsWith('=')) continue;
    const id=r;
    alumnos.push({id,nombre});
    asistencias[id]={};
    for(const[col,fecha] of Object.entries(dateColMap)){
      const raw=String(row[col]||'').trim();
      if(raw==='Presente'||raw==='Falta'||raw==='Permiso') asistencias[id][fecha]=raw;
    }
  }
  return alumnos.length>0?{alumnos:alumnos.sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'})),asistencias,fechas}:null;
}

function normalizeDate(s){
  if(/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/.test(s)){
    const p=s.replace(/\//g,'-').split('-');
    return `${p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
  }
  if(/^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/.test(s)){
    const p=s.split(/[-\/]/);
    return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  }
  const n=Number(s);
  if(!isNaN(n)&&n>40000&&n<60000)
    return new Date((n-25569)*86400*1000).toISOString().split('T')[0];
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModule(key){
  const d=state[key];
  const fecha=document.getElementById(`date-${key}`)?.value||today;
  const q=(document.getElementById(`search-${key}`)?.value||'').toLowerCase();
  const thr=parseInt(document.getElementById(`thr-${key}`)?.value||3);
  const filtered=d.alumnos.filter(a=>a.nombre.toLowerCase().includes(q));

  document.getElementById(`modTitle-${key}`).textContent=`${d.alumnos.length} alumno(s) registrado(s)`;

  let pres=0,falt=0,perm=0,alerts=0;
  const tbody=document.getElementById(`tbody-${key}`);
  if(!tbody) return;
  tbody.innerHTML='';

  if(filtered.length===0){
    tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="ei">${d.alumnos.length===0?'ğŸ“‹':'ğŸ”'}</div>${d.alumnos.length===0?'Sin alumnos. Importa un Excel o agrega manualmente.':'Sin resultados.'}</div></td></tr>`;
  }

  filtered.forEach((a,idx)=>{
    const reg=d.asistencias[a.id]||{};
    const hoy=reg[fecha]||'';
    if(hoy==='Presente') pres++;
    else if(hoy==='Falta') falt++;
    else if(hoy==='Permiso') perm++;

    const hist=d.fechas.filter(f=>f!==fecha).slice(-15);
    const totalF=Object.values(reg).filter(v=>v==='Falta').length;
    const totalDias=d.fechas.filter(f=>f<=fecha).length;
    const totalOk=Object.values(reg).filter(v=>v==='Presente'||v==='Permiso').length;
    const pct=totalDias>0?Math.round((totalOk/totalDias)*100):0;
    const enAlerta=totalF>=thr;
    if(enAlerta) alerts++;

    const barCol=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';

    const tr=document.createElement('tr');
    const motivoHoy = (d.motivos && d.motivos[a.id] && d.motivos[a.id][fecha]) || null;
    tr.innerHTML=`
      <td style="color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.75rem">${idx+1}</td>
      <td>
        <div class="aname" onclick="showPerfil('${key}',${a.id})" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px">${a.nombre}</div>
        ${enAlerta?`<div class="asub" style="color:var(--red)">âš ï¸ ${totalF} falta(s)</div>`:''}
      </td>
      <td>
        <div class="abgroup">
          <button class="ab${hoy==='Presente'?' presente':''}" onclick="setAsist('${key}',${a.id},'${fecha}','Presente')">âœ… P</button>
          <button class="ab${hoy==='Falta'?' falta':''}${motivoHoy&&hoy==='Falta'?' has-motivo':''}" onclick="setAsistConMotivo('${key}',${a.id},'${fecha}','Falta')">âŒ F</button>
          <button class="ab${hoy==='Permiso'?' permiso':''}${motivoHoy&&hoy==='Permiso'?' has-motivo':''}" onclick="setAsistConMotivo('${key}',${a.id},'${fecha}','Permiso')">ğŸ”µ Pm</button>
        </div>
      </td>
      <td>
        <div class="hdots">
          ${hist.map(f=>{const v=reg[f]||'none';const mv=(d.motivos&&d.motivos[a.id]&&d.motivos[a.id][f]);return`<div class="hd ${v}" title="${f}: ${v}${mv?'\nğŸ“ '+mv.texto:''}" style="${mv?'box-shadow:0 0 0 1.5px var(--amber)':''}"></div>`;}).join('')}
        </div>
      </td>
      <td>
        <div class="pbar">
          <div class="pbg"><div class="pfill" style="width:${pct}%;background:${barCol}"></div></div>
          <span class="pval" style="color:${barCol}">${pct}%</span>
        </div>
      </td>
      <td>
        <div style="display:flex;gap:4px">
          <button class="btn btn-red" style="padding:3px 8px;font-size:.7rem" onclick="eliminarAlumno('${key}',${a.id})">âœ•</button>
          <button class="btn-retirar" onclick="retirarAlumno('${key}',${a.id})">ğŸ“¤ Retirar</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById(`st-pres-${key}`).textContent=pres;
  document.getElementById(`st-falt-${key}`).textContent=falt;
  document.getElementById(`st-perm-${key}`).textContent=perm;
  document.getElementById(`st-alert-${key}`).textContent=alerts;

  const enAlertaList=d.alumnos.filter(a=>Object.values(d.asistencias[a.id]||{}).filter(v=>v==='Falta').length>=thr);
  const ab=document.getElementById(`alertBar-${key}`);
  if(enAlertaList.length>0){
    ab.classList.add('show');
    document.getElementById(`alertTxt-${key}`).innerHTML=
      `<strong>${enAlertaList.length} alumno(s) con ${thr}+ faltas:</strong> ${enAlertaList.map(a=>a.nombre.split(' ')[0]).join(', ')}`;
  } else ab.classList.remove('show');

  renderChart(key);
  renderRetirados(key);
  renderNotas(key);
}

// â”€â”€ Selector de fecha rÃ¡pido â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDateQuick(key, tipo){
  const inp = document.getElementById(`date-${key}`); if(!inp) return;
  if(tipo==='hoy'){
    inp.value = today;
  } else if(tipo==='ayer'){
    const ayer = new Date(); ayer.setDate(ayer.getDate()-1);
    inp.value = ayer.toISOString().split('T')[0];
  }
  onDateChange(key);
}

function onDateChange(key){
  renderModule(key);
  updateDateBar(key);
}

function updateDateBar(key){
  const inp  = document.getElementById(`date-${key}`); if(!inp) return;
  const fecha = inp.value;
  const info  = document.getElementById(`dateInfo-${key}`);
  const btnH  = document.getElementById(`btnHoy-${key}`);
  const btnA  = document.getElementById(`btnAyer-${key}`);
  const thAsist = document.getElementById(`th-asist-${key}`);
  const ayer  = new Date(); ayer.setDate(ayer.getDate()-1);
  const ayerStr = ayer.toISOString().split('T')[0];

  // Actualizar botones activos
  if(btnH) btnH.classList.toggle('active', fecha===today);
  if(btnA) btnA.classList.toggle('active', fecha===ayerStr);

  // Actualizar info badge y cabecera de tabla
  if(info){
    if(fecha===today){
      info.textContent='ğŸ“… Hoy';
      info.className='date-selector-info hoy';
    } else {
      const [y,m,d]=fecha.split('-');
      const label=`${d}/${m}/${y}`;
      info.textContent=`ğŸ“† Fecha pasada: ${label}`;
      info.className='date-selector-info pasado';
    }
  }
  if(thAsist){
    if(fecha===today) thAsist.textContent='Asistencia hoy';
    else {
      const [y,m,d]=fecha.split('-');
      thAsist.textContent=`Asistencia ${d}/${m}/${y}`;
    }
  }
}

// Inicializar date bars al cargar pÃ¡ginas
function initDateBar(key){
  updateDateBar(key);
}

function setAsist(key,id,fecha,val){
  const d=state[key];
  if(!d.asistencias[id]) d.asistencias[id]={};
  if(d.asistencias[id][fecha]===val){
    delete d.asistencias[id][fecha];
    if(d.motivos?.[id]?.[fecha]) delete d.motivos[id][fecha];
    val='';
  } else {
    d.asistencias[id][fecha]=val;
    if(val==='Presente' && d.motivos?.[id]?.[fecha]) delete d.motivos[id][fecha];
    if(!d.fechas.includes(fecha)){d.fechas.push(fecha);d.fechas.sort();}
  }
  renderModule(key);
  scheduleSync();
  syncAsist(key, id, fecha, val);
  checkAndSendAlert(key, id);
  // Historial
  const alumno=d.alumnos.find(a=>a.id===id)||(d.retirados||[]).find(a=>a.id===id);
  if(alumno && typeof addHistorial==='function'){
    const lbl=key.replace('M-','MaÃ±ana M').replace('T-','Tarde M');
    const icons={'Presente':'âœ…','Falta':'âŒ','Permiso':'ğŸ”µ','':'â†©ï¸'};
    const labels={'Presente':'Presente','Falta':'Falta','Permiso':'Permiso','':'eliminada'};
    addHistorial(icons[val]||'ğŸ“',`${alumno.nombre} â€” ${labels[val]||val}`,`${lbl} Â· ${fecha}`);
  }
}

// â”€â”€ Falta/Permiso con motivo (crear o editar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAsistConMotivo(key,id,fecha,val){
  const d=state[key];
  if(!d.asistencias[id]) d.asistencias[id]={};
  if(!d.motivos) d.motivos={};
  if(!d.motivos[id]) d.motivos[id]={};

  const actual = d.asistencias[id][fecha];
  const existing = d.motivos[id][fecha]||{};

  // Si ya tiene este valor â†’ abrir modal para EDITAR motivo (no toggle)
  // Si tiene otro valor o vacÃ­o â†’ cambiar valor y pedir motivo
  // Solo toggle off si se hace clic en el mismo botÃ³n sin motivo
  const esMismovalor = actual===val;
  const tieneMotivo  = !!(existing.texto);

  // Si mismo valor y tiene motivo â†’ abrir a editar
  // Si mismo valor y sin motivo â†’ quitar (toggle off)
  if(esMismovalor && !tieneMotivo){
    delete d.asistencias[id][fecha];
    delete d.motivos[id][fecha];
    renderModule(key); scheduleSync(); syncAsist(key,id,fecha,'',''); return;
  }

  const alumno = d.alumnos.find(a=>a.id===id);
  const icon   = val==='Falta'?'âŒ':'ğŸ”µ';
  const esEdicion = esMismovalor && tieneMotivo;

  const html=`
  <div class="motivo-grid">
    <div>
      <div class="flabel">Motivo de la ${val==='Falta'?'falta':'permiso'} <span style="color:var(--muted);font-size:.72rem">(aparecerÃ¡ en Google Sheets)</span></div>
      <textarea class="finp" id="motivoTxt" rows="3" placeholder="Ej: cita mÃ©dica, viaje, llegÃ³ tarde..." style="resize:vertical">${existing.texto||''}</textarea>
    </div>
    <div>
      <div class="flabel" style="margin-bottom:6px">Foto de evidencia <span style="color:var(--muted);font-size:.72rem">(opcional)</span></div>
      <div class="foto-preview" id="fotoPreview" onclick="document.getElementById('fotoInput').click()">
        ${existing.foto?`<img src="${existing.foto}" alt="evidencia">`:'ğŸ“· Clic para subir foto'}
      </div>
      <input type="file" id="fotoInput" accept="image/*" style="display:none" onchange="previewFoto(this)">
      ${existing.foto?`<button class="btn btn-red" style="font-size:.7rem;margin-top:6px;padding:3px 8px" onclick="clearFoto()">âœ• Quitar foto</button>`:''}
    </div>
    ${esEdicion?`<div style="font-size:.72rem;color:var(--muted);padding:4px 0">ğŸ’¡ Editando motivo existente â€” deja el campo vacÃ­o para borrarlo</div>`:''}
  </div>`;

  showModal(
    `${icon} ${esEdicion?'Editar motivo':'Registrar '+val} â€” ${alumno?.nombre?.split(' ').slice(0,2).join(' ')||''}`,
    '', ()=>{
      const texto = document.getElementById('motivoTxt')?.value.trim()||'';
      const fotoEl = document.getElementById('fotoPreview')?.querySelector('img');
      const foto   = fotoEl ? fotoEl.src : (existing.foto||'');

      // Guardar asistencia
      d.asistencias[id][fecha] = val;
      if(!d.fechas.includes(fecha)){d.fechas.push(fecha);d.fechas.sort();}

      // Guardar o borrar motivo
      if(texto||foto){
        d.motivos[id][fecha] = { texto, foto, tipo:val };
      } else {
        delete d.motivos[id][fecha];
      }

      closeModal();
      renderModule(key);
      scheduleSync();
      syncAsist(key, id, fecha, val, texto);
      checkAndSendAlert(key, id);
      showToast(`${icon} ${val}${texto?' â€” "'+texto.substring(0,30)+(texto.length>30?'...':'')+'"':' registrada'}`);
    }, html
  );

  document.getElementById('mOk').textContent = esEdicion ? 'ğŸ’¾ Guardar cambios' : `Registrar ${val}`;
  setTimeout(()=>{
    const m=document.querySelector('.modal');
    if(m) m.style.maxWidth='520px';
    // Enfocar el textarea
    document.getElementById('motivoTxt')?.focus();
  },50);
}

window._fotoBase64='';
function previewFoto(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const prev=document.getElementById('fotoPreview');
    if(prev) prev.innerHTML=`<img src="${e.target.result}" alt="evidencia">`;
    window._fotoBase64=e.target.result;
  };
  reader.readAsDataURL(file);
}
function clearFoto(){
  const prev=document.getElementById('fotoPreview');
  if(prev) prev.innerHTML='ğŸ“· Clic para subir foto';
  window._fotoBase64='';
}

// â”€â”€ Perfil completo del alumno â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPerfil(key,id){
  const d=state[key];
  const a=d.alumnos.find(x=>x.id===id); if(!a) return;
  const reg=d.asistencias[a.id]||{};
  const motivos=d.motivos||{};
  const P=Object.values(reg).filter(v=>v==='Presente').length;
  const F=Object.values(reg).filter(v=>v==='Falta').length;
  const Pm=Object.values(reg).filter(v=>v==='Permiso').length;
  const tot=d.fechas.length;
  const pct=tot>0?Math.round(((P+Pm)/tot)*100):0;
  const pcol=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';

  // Historial de clases con motivos
  const histHtml=d.fechas.length===0
    ?'<div style="color:var(--muted);font-size:.8rem;text-align:center;padding:12px">Sin clases registradas</div>'
    :d.fechas.slice().reverse().map(f=>{
      const v=reg[f]||'â€”';
      const mv=motivos[a.id]?.[f];
      const col=v==='Presente'?'var(--green)':v==='Falta'?'var(--red)':v==='Permiso'?'var(--blue)':'var(--muted)';
      return`<div style="display:flex;gap:10px;align-items:flex-start;padding:7px 0;border-bottom:1px solid var(--border);font-size:.78rem">
        <span style="color:var(--muted);min-width:82px;font-family:'JetBrains Mono',monospace">${f}</span>
        <span style="color:${col};font-weight:600;min-width:60px">${v}</span>
        ${mv?`<div style="flex:1">
          ${mv.texto?`<div style="color:var(--muted2)">${mv.texto}</div>`:''}
          ${mv.foto?`<img src="${mv.foto}" style="max-width:80px;max-height:60px;border-radius:5px;margin-top:4px;object-fit:cover;cursor:pointer" onclick="window.open('${mv.foto}','_blank')">`:''}
        </div>`:''}
      </div>`;
    }).join('');

  const html=`
  <div class="profile-header">
    <div class="profile-avatar">${a.nombre.charAt(0).toUpperCase()}</div>
    <div>
      <div class="profile-name">${a.nombre}</div>
      <div style="font-size:.75rem;color:var(--muted);margin-top:3px">${key.replace('M-','MaÃ±ana M').replace('T-','Tarde M')}</div>
      <div style="font-size:.85rem;font-weight:700;color:${pcol};margin-top:4px">${pct}% asistencia</div>
    </div>
  </div>
  <div class="profile-fields">
    ${a.dni?`<div class="pf-item"><div class="pf-label">DNI</div><div class="pf-val">${a.dni}</div></div>`:''}
    ${a.cel?`<div class="pf-item"><div class="pf-label">Celular</div><div class="pf-val">${a.cel}</div></div>`:''}
    ${a.correo?`<div class="pf-item" style="grid-column:1/-1"><div class="pf-label">Correo</div><div class="pf-val">${a.correo}</div></div>`:''}
    ${a.fecha?`<div class="pf-item"><div class="pf-label">Nacimiento</div><div class="pf-val">${a.fecha}</div></div>`:''}
    ${a.edad?`<div class="pf-item"><div class="pf-label">Edad</div><div class="pf-val">${a.edad} aÃ±os</div></div>`:''}
  </div>
  <!-- Mini chart -->
  <div class="chart-wrap">
    <div class="chart-title">Resumen de asistencia</div>
    <div style="display:flex;gap:16px;align-items:center">
      ${[['Presentes',P,'var(--green)'],['Faltas',F,'var(--red)'],['Permisos',Pm,'var(--blue)'],['Total clases',tot,'var(--muted)']].map(([l,n,c])=>
        `<div style="text-align:center"><div style="font-size:1.4rem;font-weight:800;color:${c}">${n}</div><div style="font-size:.68rem;color:var(--muted)">${l}</div></div>`
      ).join('')}
    </div>
  </div>
  <!-- Historial -->
  <div style="font-size:.76rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Historial de clases</div>
  <div style="max-height:220px;overflow-y:auto">${histHtml}</div>`;

  showModal('ğŸ‘¤ Perfil del alumno','', null, html);
  document.getElementById('mOk').style.display='none';
  setTimeout(()=>{
    const m=document.querySelector('.modal');
    if(m) m.style.maxWidth='580px';
  },10);
}

// â”€â”€ Renderizar secciÃ³n de retirados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRetirados(key){
  const el=document.getElementById(`retirados-section-${key}`); if(!el) return;
  const d=state[key];
  const lista=(d.retirados||[]);
  if(lista.length===0){ el.style.display='none'; return; }
  el.style.display='block';
  const bodyId=`ret-body-${key}`;
  el.innerHTML=`
  <div class="retirados-section">
    <div class="retirados-toggle" onclick="document.getElementById('${bodyId}').style.display=document.getElementById('${bodyId}').style.display==='none'?'block':'none'">
      <span>ğŸ“¤ Alumnos retirados</span>
      <span class="retirados-badge">${lista.length}</span>
    </div>
    <div id="${bodyId}" style="display:none">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Alumno</th><th>% Asist.</th><th></th></tr></thead>
          <tbody>
            ${lista.map(a=>{
              const reg=d.asistencias[a.id]||{};
              const P=Object.values(reg).filter(v=>v==='Presente').length;
              const tot=d.fechas.length;
              const pct=tot>0?Math.round((P/tot)*100):0;
              return`<tr>
                <td><div class="aname" style="color:var(--text2)">${a.nombre}</div></td>
                <td><span style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--muted)">${pct}%</span></td>
                <td><button class="btn-reactivar" onclick="reactivarAlumno('${key}',${a.id})">â™»ï¸ Reactivar</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

// â”€â”€ Retirar alumno â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function retirarAlumno(key,id){
  const d=state[key];
  const alumno=d.alumnos.find(a=>a.id===id); if(!alumno) return;
  const [turno, modNum] = key.split('-');
  const modNumInt = parseInt(modNum);

  showModal(
    'ğŸ“¤ Retirar alumno',
    `Â¿Confirmas retirar a "${alumno.nombre}"? Se retirarÃ¡ en este mÃ³dulo y en los siguientes del mismo turno.`,
    async ()=>{
      d.alumnos=d.alumnos.filter(a=>a.id!==id);
      if(!d.retirados) d.retirados=[];
      d.retirados.push({...alumno, retirado:true});

      [2,3,4,5,6,7,8,9].forEach(m=>{
        if(m <= modNumInt) return;
        const otroKey=`${turno}-${m}`;
        if(!state[otroKey]) return;
        const otro=state[otroKey];
        const encontrado=otro.alumnos.find(a=>
          a.nombre.trim().toLowerCase()===alumno.nombre.trim().toLowerCase()
        );
        if(encontrado){
          otro.alumnos=otro.alumnos.filter(a=>a.id!==encontrado.id);
          if(!otro.retirados) otro.retirados=[];
          otro.retirados.push({...encontrado, retirado:true});
        }
      });

      closeModal();
      renderModule(key);
      scheduleSync();

      if(GAS_URL && alumno.fila){
        setSyncStatus('saving');
        try{
          await fetch(GAS_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},
            body:JSON.stringify({action:'retirarAlumno',key,fila:alumno.fila,nombre:alumno.nombre})});
          setSyncStatus('cloudsaved');
        }catch(e){ setSyncStatus('error','Error al retirar en Sheets'); }
      }
      if(typeof addHistorial==='function'){
        const lbl=key.replace('M-','MaÃ±ana M').replace('T-','Tarde M');
        addHistorial('ğŸ“¤',`${alumno.nombre} retirado`,lbl);
      }
      showToast(`ğŸ“¤ "${alumno.nombre}" retirado en mÃ³dulo ${modNum} y siguientes`);
    }
  );
}
function renderChart(key){
  const el=document.getElementById(`chart-${key}`); if(!el) return;
  const d=state[key];
  if(!d||d.fechas.length===0){ el.innerHTML='<div style="color:var(--muted);font-size:.78rem;text-align:center;padding:16px">Sin datos aÃºn</div>'; return; }
  // Ãšltimas 10 fechas
  const fechas=d.fechas.slice(-10);
  const maxH=60;
  el.innerHTML=`<div class="chart-bars">`+fechas.map(f=>{
    const total=d.alumnos.length||1;
    const P=d.alumnos.filter(a=>(d.asistencias[a.id]||{})[f]==='Presente').length;
    const pct=Math.round((P/total)*100);
    const h=Math.max(4,Math.round((pct/100)*maxH));
    const col=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';
    const short=f.slice(5).replace('-','/');
    return`<div class="chart-bar-col">
      <div class="chart-bar-val" style="color:${col}">${pct}%</div>
      <div class="chart-bar" style="height:${h}px;background:${col}"></div>
      <div class="chart-bar-label">${short}</div>
    </div>`;
  }).join('')+'</div>';
}

// â”€â”€ Alerta por correo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAndSendAlert(key,id){
  if(!GAS_URL) return;
  const d=state[key];
  const a=d.alumnos.find(x=>x.id===id); if(!a||!a.correo) return;
  const thr=parseInt(document.getElementById(`thr-${key}`)?.value||3);
  const faltas=Object.values(d.asistencias[id]||{}).filter(v=>v==='Falta').length;
  if(faltas===thr){ // solo al alcanzar exactamente el umbral
    const [t,m]=key.split('-');
    gasPost({
      action:'sendAlert',
      nombre: a.nombre,
      correo: a.correo,
      faltas,
      modulo: `${t==='M'?'MaÃ±ana':'Tarde'} MÃ³dulo ${m}`,
      umbral: thr
    });
    showToast(`ğŸ“§ Alerta enviada a ${a.correo}`);
  }
}

function marcarTodos(key,val){
  const d=state[key];
  const fecha=document.getElementById(`date-${key}`)?.value||today;
  d.alumnos.forEach(a=>{
    if(!d.asistencias[a.id]) d.asistencias[a.id]={};
    d.asistencias[a.id][fecha]=val;
    syncAsist(key, a.id, fecha, val);
  });
  if(!d.fechas.includes(fecha)){d.fechas.push(fecha);d.fechas.sort();}
  scheduleSync();
  renderModule(key);
  showToast('âœ… Todos marcados como Presente');
}

function eliminarAlumno(key,id){
  const alumno=state[key].alumnos.find(a=>a.id===id);
  const esM1 = key.split('-')[1]==='1';
  const msg = esM1
    ? `Â¿Seguro que deseas eliminar a "${alumno?.nombre}"? Se eliminarÃ¡ tambiÃ©n de los demÃ¡s mÃ³dulos del mismo turno.`
    : `Â¿Seguro que deseas eliminar a "${alumno?.nombre}" de este mÃ³dulo?`;

  showModal('Eliminar alumno', msg, ()=>{
    const d=state[key];
    d.alumnos=d.alumnos.filter(a=>a.id!==id);
    delete d.asistencias[id];

    // Si es M1, tambiÃ©n eliminar del estado local de los otros mÃ³dulos del turno
    if(esM1 && alumno){
      const turno=key.split('-')[0];
      [2,3,4].forEach(m=>{
        const otroKey=`${turno}-${m}`;
        if(state[otroKey]){
          state[otroKey].alumnos=state[otroKey].alumnos.filter(
            a=>a.nombre.trim().toLowerCase()!==alumno.nombre.trim().toLowerCase()
          );
        }
      });
    }

    closeModal();
    renderModule(key);
    showToast(esM1?'âœ… Alumno eliminado de todos los mÃ³dulos':'âœ… Alumno eliminado');
    scheduleSync();
    if(alumno?.fila) syncDeleteAlumno(key, alumno.fila, alumno.nombre);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD ALUMNO MODAL (mÃ³dulos)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAddAlumnoModal(key){
  const [t,m]=key.split('-');
  const label=`${TURNOS[t].label} â€” MÃ³dulo ${m}`;
  showModal(
    `â• Agregar alumno â€” ${label}`,
    '',
    ()=>{
      const nombre=document.getElementById('addNombreInp')?.value.trim();
      if(!nombre){showToast('âš ï¸ Escribe el nombre');return;}
      const d=state[key];
      const id=Date.now();
      d.alumnos.push({
        id, nombre,
        dni:    document.getElementById('addDniInp')?.value.trim()||'',
        fecha:  document.getElementById('addFechaInp')?.value||'',
        edad:   document.getElementById('addEdadInp')?.value.trim()||'',
        correo: document.getElementById('addCorreoInp')?.value.trim()||'',
        cel:    document.getElementById('addCelInp')?.value.trim()||'',
      });
      d.asistencias[id]={};
      sortAlumnos(d);
      closeModal();
      renderModule(key);
      showToast(`âœ… "${nombre}" agregado`);
      const alumno=d.alumnos.find(a=>a.id===id);
      syncAddAlumno(key, alumno||{nombre});
    },
    `<div class="form-grid" style="margin-top:4px">
      <div class="fgroup" style="grid-column:1/-1"><div class="flabel">Apellidos y Nombres *</div><input class="finp" id="addNombreInp" placeholder="Ej: GarcÃ­a LÃ³pez Ana" autofocus></div>
      <div class="fgroup"><div class="flabel">DNI</div><input class="finp" id="addDniInp" placeholder="12345678" maxlength="8"></div>
      <div class="fgroup"><div class="flabel">Fecha de nacimiento</div><input class="finp" type="date" id="addFechaInp"></div>
      <div class="fgroup"><div class="flabel">Edad</div><input class="finp" id="addEdadInp" placeholder="25" type="number" min="1" max="99"></div>
      <div class="fgroup"><div class="flabel">Correo</div><input class="finp" id="addCorreoInp" placeholder="correo@gmail.com" type="email"></div>
      <div class="fgroup"><div class="flabel">Celular</div><input class="finp" id="addCelInp" placeholder="999 999 999"></div>
    </div>`
  );
  setTimeout(()=>document.getElementById('addNombreInp')?.focus(),100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SORT HELPER â€” A-Z por apellidos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sortAlumnos(d){
  d.alumnos.sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSONALIZADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function agregarPersonalizado(){
  const nombre=document.getElementById('pNombre').value.trim();
  if(!nombre){showToast('âš ï¸ El nombre es obligatorio');return;}
  const p={
    id:Date.now(),
    nombre,
    dni:    document.getElementById('pDni').value.trim(),
    fecha:  document.getElementById('pFecha').value,
    edad:   document.getElementById('pEdad').value.trim(),
    correo: document.getElementById('pCorreo').value.trim(),
    tel:    document.getElementById('pTel').value.trim(),
    tema:   document.getElementById('pTema').value.trim(),
    horario:document.getElementById('pHorario').value.trim(),
    clases:[]
  };
  personalizados.push(p);
  personalizados.sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}));
  ['pNombre','pDni','pFecha','pEdad','pCorreo','pTel','pTema','pHorario'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  renderPersonalizados();
  showToast(`âœ… "${nombre}" agregado`);
  syncPersonalizados();
}

function registrarClasePersonalizada(pid,fecha,val){
  const p=personalizados.find(x=>x.id===pid);
  if(!p) return;
  const idx=p.clases.findIndex(c=>c.fecha===fecha);
  if(idx>=0&&p.clases[idx].val===val) p.clases.splice(idx,1);
  else if(idx>=0) p.clases[idx].val=val;
  else p.clases.push({fecha,val});
  p.clases.sort((a,b)=>a.fecha.localeCompare(b.fecha));
  renderPersonalizados();
  syncPersonalizados();
}

function eliminarPersonalizado(pid){
  showModal('Eliminar alumno','Â¿Seguro que deseas eliminar este alumno personalizado?',()=>{
    personalizados=personalizados.filter(p=>p.id!==pid);
    closeModal();
    renderPersonalizados();
    showToast('Alumno eliminado');
    syncPersonalizados();
  });
}

function renderPersonalizados(){
  const q=(document.getElementById('persSearch')?.value||'').toLowerCase();
  const filtered=personalizados.filter(p=>p.nombre.toLowerCase().includes(q)||
    (p.dni&&p.dni.includes(q))||(p.correo&&p.correo.toLowerCase().includes(q)));
  const container=document.getElementById('persList');

  if(filtered.length===0){
    container.innerHTML=`<div class="empty"><div class="ei">ğŸ‘¤</div>${personalizados.length===0?'Sin alumnos personalizados. AgrÃ©galos con el formulario de arriba.':'Sin resultados.'}</div>`;
    return;
  }

  container.innerHTML=filtered.map((p,idx)=>{
    const totalC=p.clases.length;
    const totalP=p.clases.filter(c=>c.val==='Presente').length;
    const pct=totalC>0?Math.round((totalP/totalC)*100):0;
    const pcol=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';

    return`
    <div class="pers-card">
      <div class="pers-card-top">
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <span style="font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:5px;padding:2px 7px">${String(idx+1).padStart(2,'0')}</span>
            <div class="pers-name">${p.nombre}</div>
            ${pct>0?`<span style="font-size:.72rem;font-weight:700;color:${pcol}">${pct}%</span>`:''}
          </div>
          <div class="pers-meta" style="margin-top:6px">
            ${p.dni    ?`<div class="pmeta">ğŸªª DNI: <strong style="color:var(--text)">${p.dni}</strong></div>`:''}
            ${p.fecha  ?`<div class="pmeta">ğŸ‚ ${p.fecha}${p.edad?` Â· ${p.edad} aÃ±os`:''}</div>`:(p.edad?`<div class="pmeta">ğŸ‘¤ ${p.edad} aÃ±os</div>`:'')}
            ${p.correo ?`<div class="pmeta">âœ‰ï¸ ${p.correo}</div>`:''}
            ${p.tel    ?`<div class="pmeta">ğŸ“ ${p.tel}</div>`:''}
            ${p.tema   ?`<div class="pmeta">ğŸ“š ${p.tema}</div>`:''}
            ${p.horario?`<div class="pmeta">ğŸ• ${p.horario}</div>`:''}
            ${totalC>0 ?`<div class="pmeta" style="color:${pcol}">ğŸ“Š ${totalP}/${totalC} clases asistidas</div>`:''}
          </div>
        </div>
        <div class="pers-actions">
          <button class="btn btn-outline" style="font-size:.72rem;padding:4px 10px" onclick="editarPersonalizado(${p.id})">âœï¸ Editar</button>
          <button class="btn btn-red" onclick="eliminarPersonalizado(${p.id})">âœ•</button>
        </div>
      </div>
      <div class="pers-clases">
        <div class="pers-clases-list">
          ${p.clases.length===0?`<span style="font-size:.78rem;color:var(--muted)">Sin clases registradas aÃºn</span>`:''}
          ${p.clases.map(c=>`
            <div class="clase-chip" title="Clic para quitar" onclick="registrarClasePersonalizada(${p.id},'${c.fecha}','${c.val}')">
              <span class="cc-date">${c.fecha}</span>
              <span class="cc-val ${c.val}">${c.val}</span>
            </div>`).join('')}
        </div>
        <div class="clase-add">
          <span style="font-size:.75rem;color:var(--muted);font-weight:600">Registrar clase:</span>
          <input type="date" class="inp" id="pd-${p.id}" value="${today}" style="font-size:.78rem;padding:4px 8px">
          <button class="btn btn-green"   style="font-size:.73rem;padding:4px 10px" onclick="registrarClasePersonalizada(${p.id},document.getElementById('pd-${p.id}').value,'Presente')">âœ… Presente</button>
          <button class="btn btn-red"     style="font-size:.73rem;padding:4px 10px" onclick="registrarClasePersonalizada(${p.id},document.getElementById('pd-${p.id}').value,'Falta')">âŒ Falta</button>
          <button class="btn btn-outline" style="font-size:.73rem;padding:4px 10px;border-color:var(--blue);color:var(--blue)" onclick="registrarClasePersonalizada(${p.id},document.getElementById('pd-${p.id}').value,'Permiso')">ğŸ”µ Permiso</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function editarPersonalizado(pid){
  const p=personalizados.find(x=>x.id===pid); if(!p) return;
  const html=`
    <div class="form-grid" style="margin-top:4px">
      <div class="fgroup" style="grid-column:1/-1"><div class="flabel">Apellidos y Nombres *</div><input class="finp" id="epNombre" value="${p.nombre}"></div>
      <div class="fgroup"><div class="flabel">DNI</div><input class="finp" id="epDni" value="${p.dni||''}"></div>
      <div class="fgroup"><div class="flabel">Fecha de nacimiento</div><input class="finp" type="date" id="epFecha" value="${p.fecha||''}"></div>
      <div class="fgroup"><div class="flabel">Edad</div><input class="finp" id="epEdad" type="number" value="${p.edad||''}"></div>
      <div class="fgroup"><div class="flabel">Correo</div><input class="finp" id="epCorreo" type="email" value="${p.correo||''}"></div>
      <div class="fgroup"><div class="flabel">Celular</div><input class="finp" id="epTel" value="${p.tel||''}"></div>
      <div class="fgroup"><div class="flabel">Tema / Materia</div><input class="finp" id="epTema" value="${p.tema||''}"></div>
      <div class="fgroup"><div class="flabel">Horario / DÃ­a</div><input class="finp" id="epHorario" value="${p.horario||''}"></div>
    </div>`;
  showModal('âœï¸ Editar alumno','',()=>{
    const nombre=document.getElementById('epNombre')?.value.trim();
    if(!nombre){showToast('âš ï¸ El nombre es obligatorio');return;}
    p.nombre  = nombre;
    p.dni     = document.getElementById('epDni')?.value.trim()||'';
    p.fecha   = document.getElementById('epFecha')?.value||'';
    p.edad    = document.getElementById('epEdad')?.value.trim()||'';
    p.correo  = document.getElementById('epCorreo')?.value.trim()||'';
    p.tel     = document.getElementById('epTel')?.value.trim()||'';
    p.tema    = document.getElementById('epTema')?.value.trim()||'';
    p.horario = document.getElementById('epHorario')?.value.trim()||'';
    personalizados.sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}));
    closeModal();
    renderPersonalizados();
    showToast('âœ… Datos actualizados');
    syncPersonalizados();
  }, html);
  document.getElementById('mOk').textContent='Guardar cambios';
}
function renderDashboard(){
  let totalAl=0,todayPres=0,todayFalt=0,totalAlerts=0;
  const keys=['M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'];
  const thr=3;

  keys.forEach(key=>{
    // Garantizar estructura mÃ­nima aunque state no estÃ© completo
    if(!state[key]) state[key]={alumnos:[],retirados:[],asistencias:{},fechas:{},motivos:{},notas:{}};
    const d=state[key];
    if(!d.alumnos) d.alumnos=[];
    if(!d.asistencias) d.asistencias={};
    totalAl+=d.alumnos.length;
    d.alumnos.forEach(a=>{
      const reg=d.asistencias[a.id]||{};
      if(reg[today]==='Presente') todayPres++;
      if(reg[today]==='Falta')    todayFalt++;
      if(Object.values(reg).filter(v=>v==='Falta').length>=thr) totalAlerts++;
    });
  });

  document.getElementById('d-total').textContent=totalAl;
  document.getElementById('d-pres').textContent=todayPres;
  document.getElementById('d-falt').textContent=todayFalt;
  document.getElementById('d-alert').textContent=totalAlerts;
  document.getElementById('d-pers').textContent=personalizados.length;

  // Cards per turno
  const dashCards=document.getElementById('dashCards');
  dashCards.innerHTML=['M','T'].map(t=>{
    const turnKeys=[1,2,3,4].map(m=>`${t}-${m}`);
    const rows=turnKeys.map(key=>{
      const d=state[key];
      const m=key.split('-')[1];
      const total=d.alumnos.length;
      if(total===0) return `<div class="dash-row"><span class="dr-name" style="color:var(--muted)">MÃ³dulo ${m} â€” sin datos</span><span></span></div>`;
      const vals=d.alumnos.flatMap(a=>Object.values(d.asistencias[a.id]||{}));
      const P=vals.filter(v=>v==='Presente').length;
      const tot=vals.length;
      const pct=tot>0?Math.round((P/tot)*100):0;
      const col=pct>=80?'var(--green)':pct>=60?'var(--yellow)':'var(--red)';
      return`<div class="dash-row">
        <span class="dr-name" style="cursor:pointer;text-decoration:underline;text-decoration-color:var(--border2)" onclick="goPage('${key}')">MÃ³dulo ${m} Â· ${total} alumnos</span>
        <span class="dr-pct" style="color:${col}">${pct}%</span>
      </div>`;
    }).join('');
    return`<div class="dash-card">
      <h4>${TURNOS[t].label}</h4>
      ${rows}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarTodo(){
  showModal('â¬‡ï¸ Exportar Excel','Se generarÃ¡n dos archivos: uno con los mÃ³dulos de ambos turnos y otro con los alumnos personalizados.',()=>{
    closeModal();
    exportModulos();
    if(personalizados.length>0) exportPersonalizados();
    showToast('ğŸ“¥ Excel(s) exportado(s) correctamente');
  });
}

function exportModulos(){
  const wb=XLSX.utils.book_new();
  ['M','T'].forEach(t=>[1,2,3,4].forEach(m=>{
    const key=`${t}-${m}`;
    const d=state[key];
    if(d.alumnos.length===0) return;
    const allF=[...d.fechas].sort();
    const header=['#','Nombre',...allF,'Presentes','Faltas','Permisos','% Asistencia'];
    const rows=[header];
    d.alumnos.forEach((a,i)=>{
      const reg=d.asistencias[a.id]||{};
      const row=[i+1,a.nombre];
      let P=0,F=0,Pm=0;
      allF.forEach(f=>{const v=reg[f]||'';row.push(v);if(v==='Presente')P++;else if(v==='Falta')F++;else if(v==='Permiso')Pm++;});
      const tot=P+F+Pm;
      row.push(P,F,Pm,tot>0?Math.round(((P+Pm)/tot)*100)+'%':'â€”');
      rows.push(row);
    });
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[{wch:4},{wch:30},...allF.map(()=>({wch:12})),{wch:11},{wch:11},{wch:11},{wch:14}];
    const label=`${t==='M'?'MaÃ±ana':'Tarde'} MÃ³dulo ${m}`;
    XLSX.utils.book_append_sheet(wb,ws,label);
  }));
  if(wb.SheetNames.length>0)
    XLSX.writeFile(wb,`asistencias_modulos_${today}.xlsx`);
}

function exportPersonalizados(){
  const wb=XLSX.utils.book_new();
  const rows=[['#','Apellidos y Nombres','DNI','Fecha Nac.','Edad','Correo','Celular','Tema/Materia','Horario','Total Clases','Presentes','Faltas','Permisos','% Asistencia']];
  personalizados.forEach((p,i)=>{
    const P=p.clases.filter(c=>c.val==='Presente').length;
    const F=p.clases.filter(c=>c.val==='Falta').length;
    const Pm=p.clases.filter(c=>c.val==='Permiso').length;
    const tot=p.clases.length;
    rows.push([i+1,p.nombre,p.dni||'',p.fecha||'',p.edad||'',p.correo||'',p.tel||'',p.tema||'',p.horario||'',tot,P,F,Pm,tot>0?Math.round(((P+Pm)/tot)*100)+'%':'â€”']);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:4},{wch:30},{wch:10},{wch:13},{wch:6},{wch:26},{wch:14},{wch:20},{wch:16},{wch:12},{wch:11},{wch:11},{wch:11},{wch:14}];
  XLSX.utils.book_append_sheet(wb,ws,'Personalizados');

  const det=[['Alumno','DNI','Fecha','Asistencia']];
  personalizados.forEach(p=>{
    p.clases.forEach(c=>det.push([p.nombre,p.dni||'',c.fecha,c.val]));
  });
  const ws2=XLSX.utils.aoa_to_sheet(det);
  ws2['!cols']=[{wch:30},{wch:10},{wch:14},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws2,'Detalle Clases');

  XLSX.writeFile(wb,`personalizados_${today}.xlsx`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’¾ SYNC â€” localStorage (instantÃ¡neo) + Google Sheets (background)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GAS_URL = localStorage.getItem('gas_url') || '';

// â”€â”€ localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function localSave(){
  try{
    localStorage.setItem('asist_state', JSON.stringify(state));
    localStorage.setItem('asist_pers',  JSON.stringify(personalizados));
  }catch(e){ console.warn('localStorage lleno',e); }
}

function localLoad(){
  try{
    const s=localStorage.getItem('asist_state');
    const p=localStorage.getItem('asist_pers');
    if(s){
      const parsed=JSON.parse(s);
      // Preserve motivos when loading from Sheets (merge)
      Object.keys(parsed).forEach(k=>{
        if(!state[k]) state[k]={ alumnos:[], asistencias:{}, fechas:[], motivos:{} };
        // Only load motivos from local (Sheets doesn't store them)
        if(parsed[k].motivos) state[k].motivos=parsed[k].motivos;
      });
    }
    if(p) personalizados=JSON.parse(p);
    return !!(s||p);
  }catch(e){ return false; }
}

// â”€â”€ Indicador â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(s, msg=''){
  const el=document.getElementById('syncIndicator'); if(!el) return;
  const map={
    saved:        {icon:'ğŸ’¾', text:'Guardado',       color:'var(--green)'},
    cloudsaved:   {icon:'ğŸŸ¢', text:'Sincronizado',   color:'var(--green)'},
    saving:       {icon:'ğŸ”„', text:'Guardando...',   color:'var(--yellow)'},
    loading:      {icon:'ğŸ”„', text:'Cargando...',    color:'var(--yellow)'},
    error:        {icon:'ğŸ”´', text:msg||'Error',     color:'var(--red)'},
    unconfigured: {icon:'â˜ï¸', text:'Conectar Sheets',color:'var(--muted)'},
  };
  const m=map[s]||map.saved;
  el.innerHTML=`<span onclick="showCloudConfig()" style="color:${m.color};font-size:.75rem;display:flex;align-items:center;gap:4px;cursor:pointer" title="Configurar Google Sheets">${m.icon} ${m.text}</span>`;
}

// â”€â”€ scheduleSync: guarda local YA â€” nunca bloquea UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleSync(){
  localSave();
  setSyncStatus(GAS_URL ? 'cloudsaved' : 'saved');
}

// â”€â”€ GAS POST fire-and-forget (no bloquea UI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gasPost(payload){
  if(!GAS_URL) return;
  fetch(GAS_URL,{
    method:'POST', mode:'no-cors',
    headers:{'Content-Type':'text/plain'},
    body:JSON.stringify(payload)
  }).catch(e=>console.warn('GAS post:',e.message));
}

// â”€â”€ GAS GET (sÃ­ lee respuesta) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gasGet(params){
  const url=GAS_URL+'?'+new URLSearchParams(params).toString();
  const res=await fetch(url, { redirect:'follow' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text=await res.text();
  try{ return JSON.parse(text); }
  catch(e){ throw new Error('Respuesta no JSON: '+text.slice(0,120)); }
}

// â”€â”€ Sync actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncAsist(key, alumnoId, fecha, valor, motivo=''){
  const alumno=state[key]?.alumnos.find(a=>a.id===alumnoId);
  if(!alumno?.fila) return;
  gasPost({ action:'setAsist', key, fila:alumno.fila, fecha, valor, motivo });
}

function syncAddAlumno(key, alumno){
  if(!alumno) return;
  gasPost({ action:'addAlumno', key, alumno:{
    nombre: alumno.nombre||'',
    dni:    alumno.dni||'',
    correo: alumno.correo||'',
    fecha:  alumno.fecha||'',
    cel:    alumno.cel||'',
    edad:   alumno.edad||''
  }});
}

function syncDeleteAlumno(key, fila, nombre){
  if(!fila) return;
  gasPost({ action:'deleteAlumno', key, fila, nombre: nombre||'' });
}

function syncPersonalizados(){ localSave(); }

// â”€â”€ Cargar UN mÃ³dulo desde Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Cargar todos los mÃ³dulos desde Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cloudLoad(){
  if(!GAS_URL){
    const ok=localLoad();
    if(ok){ refreshCurrentPage(); showToast('ğŸ’¾ Datos restaurados del navegador'); }
    setSyncStatus('unconfigured');
    return;
  }
  setSyncStatus('loading');
  showToast('ğŸ”„ Cargando desde Google Sheets...');
  const keys=['M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'];

  // Preservar motivos y notas del localStorage
  const localRaw=localStorage.getItem('asist_state');
  const localState=localRaw?JSON.parse(localRaw):{};

  // Fetch con timeout de 15s por mÃ³dulo
  function gasGetTimeout(params, ms=15000){
    return Promise.race([
      gasGet(params),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))
    ]);
  }

  // Actualizar indicador con progreso
  let loadedCount=0;
  const updateProgress=()=>{
    const el=document.getElementById('syncIndicator');
    if(el) el.innerHTML=`<span style="color:var(--yellow-l);font-size:.75rem">ğŸ”„ Cargando ${loadedCount}/8...</span>`;
  };
  updateProgress();

  // Todas las peticiones en paralelo
  const results = await Promise.allSettled(
    keys.map(key => gasGetTimeout({ action:'load', key }).then(r=>{ loadedCount++; updateProgress(); return {key,r}; }))
  );

  let loaded=0;
  console.log('[cloudLoad] results:', results.map(r=>r.status==='fulfilled'?{key:r.value?.key,ok:r.value?.r?.ok,n:(r.value?.r?.alumnos||[]).length}:r.reason?.message));
  for(const res of results){
    if(res.status!=='fulfilled') { console.warn('cloudLoad failed:', res.reason?.message); continue; }
    const {key, r} = res.value;
    if(!r?.ok) continue;

    const alumnos=(r.alumnos||[]).map(a=>({...a, id:Number(a.id)}));
    const retirados=(r.retirados||[]).map(a=>({...a, id:Number(a.id)}));

    const asistencias={};
    Object.entries(r.asistencias||{}).forEach(([k,v])=>{ asistencias[Number(k)]=v; });

    const localRetirados=(localState[key]?.retirados)||[];
    const retiradosMerge=[...retirados];
    localRetirados.forEach(lr=>{
      const norm=String(lr.nombre||'').trim().toLowerCase();
      if(!retiradosMerge.some(r=>String(r.nombre||'').trim().toLowerCase()===norm))
        retiradosMerge.push({...lr});
    });

    const retiradosNorm=retiradosMerge.map(r=>String(r.nombre||'').trim().toLowerCase());
    const alumnosFiltrados=alumnos.filter(a=>
      !retiradosNorm.includes(String(a.nombre||'').trim().toLowerCase())
    );

    state[key]={
      alumnos:     alumnosFiltrados,
      retirados:   retiradosMerge,
      asistencias: asistencias,
      fechas:      r.fechas||[],
      motivos:     localState[key]?.motivos||{},
      notas:       localState[key]?.notas||{}
    };
    loaded++;
  }

  try{ const p=localStorage.getItem('asist_pers'); if(p) personalizados=JSON.parse(p); }catch(e){}
  try{ loadNotasFromLocal(); }catch(e){}
  try{ localSave(); }catch(e){}
  try{ refreshCurrentPage(); }catch(err){
    console.error('refreshCurrentPage error:', err);
    // Fallback: render dashboard directly
    try{ renderDashboard(); }catch(e2){ console.error('renderDashboard error:', e2); }
  }
  if(loaded>0){
    setSyncStatus('cloudsaved');
    showToast(`ğŸŸ¢ ${loaded} mÃ³dulo(s) cargados`);
  } else {
    setSyncStatus('error','Sin datos');
    showToast('âš ï¸ GAS respondiÃ³ pero sin datos vÃ¡lidos. Revisa la consola (F12).');
  }
}

function refreshCurrentPage(){
  if(!currentPage||currentPage==='dashboard') renderDashboard();
  else if(currentPage==='personalizados') renderPersonalizados();
  else if(currentPage==='mensual') renderMensual();
  else if(currentPage==='historial') renderHistorialMini();
  else { renderModule(currentPage); setTimeout(()=>initDateBar(currentPage),50); }
}

// â”€â”€ Modal de configuraciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCloudConfig(){
  const connected=!!GAS_URL;
  const html=`
  <div style="background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:.79rem;color:var(--muted);line-height:1.85;margin-bottom:14px;">
    <strong style="color:var(--text);font-size:.88rem;">ğŸ“‹ Conectar con Google Sheets</strong>
    <span style="display:block;font-size:.71rem;color:var(--muted2);margin-bottom:8px;">Solo una vez â€” luego todo es automÃ¡tico</span>
    <ol style="margin:0 0 0 16px;display:flex;flex-direction:column;gap:4px;">
      <li>Crea estas 8 hojas en tu Google Sheet:<br>
        <code style="background:var(--s3);padding:2px 6px;border-radius:3px;font-size:.7rem">MaÃ±ana M1, MaÃ±ana M2, MaÃ±ana M3, MaÃ±ana M4, Tarde M1, Tarde M2, Tarde M3, Tarde M4</code></li>
      <li>Cada hoja con cabecera en fila 1:<br>
        <code style="background:var(--s3);padding:2px 6px;border-radius:3px;font-size:.7rem">Nombres y Apellidos | DNI | NACIMIENTO | CELULAR | EDAD</code></li>
      <li>Copia el <strong style="color:var(--text)">ID de tu Sheet</strong> desde la URL y pÃ©galo en el archivo <code style="background:var(--s3);padding:1px 5px;border-radius:3px">Code.gs</code></li>
      <li>Ve a <a href="https://script.google.com" target="_blank" style="color:var(--amber)">script.google.com</a> â†’ Nuevo proyecto â†’ pega el cÃ³digo del <code style="background:var(--s3);padding:1px 5px;border-radius:3px">Code.gs</code></li>
      <li><strong style="color:var(--text)">Implementar â†’ Nueva implementaciÃ³n â†’ AplicaciÃ³n web</strong><br>
        Ejecutar como: <strong style="color:var(--text)">Yo</strong> Â· Acceso: <strong style="color:var(--text)">Cualquier usuario</strong></li>
      <li>Autorizar â†’ copiar URL â†’ pegarla abajo â†“</li>
    </ol>
    <div style="margin-top:10px;padding:8px;background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);border-radius:6px;font-size:.72rem;color:var(--green);">
      ğŸ’¾ Tus datos estÃ¡n seguros en este navegador mientras configuras.
    </div>
  </div>
  <div class="fgroup">
    <div class="flabel">URL del Apps Script</div>
    <input class="finp" id="gasUrlInp" placeholder="https://script.google.com/macros/s/.../exec" value="${GAS_URL}" style="font-size:.73rem;">
  </div>
  ${connected?`<div style="margin-top:8px;font-size:.72rem;color:var(--green)">ğŸŸ¢ Actualmente conectado Â· <span onclick="cloudLoad();closeModal();" style="color:var(--amber);cursor:pointer">Recargar desde Sheets</span> Â· <span onclick="diagnosticoGAS();" style="color:var(--sky-l);cursor:pointer">ğŸ” DiagnÃ³stico</span></div>`:''}
  <div id="diagResult" style="margin-top:8px;font-size:.72rem;display:none"></div>`; 

  showModal('â˜ï¸ SincronizaciÃ³n con Google Sheets','',async()=>{
    const url=document.getElementById('gasUrlInp')?.value.trim();
    if(!url){showToast('âš ï¸ Pega la URL del Apps Script');return;}
    if(!url.includes('script.google.com')){showToast('âš ï¸ La URL no parece vÃ¡lida');return;}
    GAS_URL=url; localStorage.setItem('gas_url',url);
    closeModal();
    await cloudLoad();
  },html);
  document.getElementById('mOk').textContent=connected?'Actualizar URL':'Conectar';

  if(connected){
    setTimeout(()=>{
      const btns=document.querySelector('.modal-btns'); if(!btns) return;
      if(document.getElementById('discBtn')) return;
      const b=document.createElement('button');
      b.id='discBtn'; b.className='btn btn-red'; b.textContent='Desconectar';
      b.onclick=()=>{
        GAS_URL=''; localStorage.removeItem('gas_url');
        closeModal(); setSyncStatus('unconfigured');
        showToast('Desconectado. Datos siguen en este navegador.');
      };
      btns.prepend(b);
    },60);
  }
}


// â”€â”€ DiagnÃ³stico de conexiÃ³n GAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function diagnosticoGAS(){
  const el=document.getElementById('diagResult'); if(!el) return;
  el.style.display='block';
  el.style.color='var(--muted)';
  el.textContent='ğŸ” Probando conexiÃ³n...';
  if(!GAS_URL){ el.textContent='âš ï¸ No hay URL configurada.'; return; }
  try{
    const r=await Promise.race([
      gasGet({action:'load', key:'M-1'}),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout 10s')),10000))
    ]);
    if(r?.ok){
      el.style.color='var(--green-l)';
      el.textContent=`âœ… ConexiÃ³n OK â€” ${(r.alumnos||[]).length} alumnos en MaÃ±ana M1`;
    } else {
      el.style.color='var(--red-l)';
      el.textContent='âŒ GAS respondiÃ³ pero con error: '+(r?.error||'desconocido');
    }
  } catch(e){
    el.style.color='var(--red-l)';
    if(e.message.includes('Timeout')){
      el.textContent='â± Timeout â€” GAS tarda demasiado. Verifica que el Web App estÃ© publicado como "Cualquier persona".';
    } else if(e.message.includes('Failed to fetch')||e.message.includes('NetworkError')){
      el.textContent='ğŸŒ Error de red/CORS â€” AsegÃºrate de que el acceso sea "Cualquier persona" (sin cuenta de Google).';
    } else {
      el.textContent='âŒ Error: '+e.message;
    }
  }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initData(){
  if(GAS_URL){ cloudLoad(); }
  else{
    const ok=localLoad();
    if(ok) setTimeout(()=>{ refreshCurrentPage(); showToast('ğŸ’¾ Datos restaurados'); },300);
    setTimeout(()=>setSyncStatus('unconfigured'),150);
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL / TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _modalCb=null;
function showModal(title,body,cb,extraHtml=''){
  document.getElementById('mTitle').textContent=title;
  document.getElementById('mBody').textContent=body;
  document.getElementById('mExtra').innerHTML=extraHtml;
  _modalCb=cb;
  document.getElementById('mOk').onclick=()=>{if(_modalCb)_modalCb();};
  document.getElementById('overlay').classList.add('show');
}
function closeModal(){ document.getElementById('overlay').classList.remove('show'); }

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

// Close modal on overlay click
document.getElementById('overlay').addEventListener('click',e=>{
  if(e.target===document.getElementById('overlay')) closeModal();
});

// â”€â”€ SIDEBAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  const isHidden=sb.classList.toggle('hidden');
  ov.classList.toggle('show',!isHidden);
}

// Auto-hide sidebar on small screens initially
function initSidebar(){
  if(window.innerWidth<900){
    document.getElementById('sidebar').classList.add('hidden');
  }
}
initSidebar();
window.addEventListener('resize',()=>{
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  if(window.innerWidth>=900){
    sb.classList.remove('hidden');
    ov.classList.remove('show');
  } else {
    sb.classList.add('hidden');
    ov.classList.remove('show');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODO CLARO / OSCURO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme(){
  const html=document.documentElement;
  const isDark=html.getAttribute('data-theme')==='dark';
  const newTheme=isDark?'light':'dark';
  html.setAttribute('data-theme',newTheme);
  localStorage.setItem('theme',newTheme);
  updateThemeLabel();
}
function updateThemeLabel(){
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const lbl=document.getElementById('themeLabel');
  if(lbl) lbl.textContent=isDark?'ğŸŒ™ Modo oscuro':'â˜€ï¸ Modo claro';
  // Fix date picker icon on light mode
  document.querySelectorAll('.date-inp-main,.inp[type=date]').forEach(el=>{
    el.style.colorScheme=isDark?'dark':'light';
  });
}
// Cargar tema guardado
(()=>{
  const saved=localStorage.getItem('theme')||'dark';
  document.documentElement.setAttribute('data-theme',saved);
  updateThemeLabel();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL DE CAMBIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HISTORIAL_KEY='asist_historial';
let historial=[];

function loadHistorial(){
  try{ historial=JSON.parse(localStorage.getItem(HISTORIAL_KEY)||'[]'); }
  catch(e){ historial=[]; }
}
function saveHistorial(){
  try{ localStorage.setItem(HISTORIAL_KEY,JSON.stringify(historial.slice(0,500))); }catch(e){}
}
function addHistorial(icon,texto,submsg=''){
  const entry={icon,texto,submsg,ts:Date.now()};
  historial.unshift(entry);
  saveHistorial();
  renderHistorialMini();
}
function formatTs(ts){
  const d=new Date(ts);
  const pad=n=>String(n).padStart(2,'0');
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function renderHistorialMini(){
  // Render in full historial page if visible
  const el=document.getElementById('historialFullList'); if(!el) return;
  if(historial.length===0){
    el.innerHTML=`<div class="historial-wrap"><div class="historial-empty">Sin cambios registrados aÃºn.</div></div>`;
    return;
  }
  el.innerHTML=`<div class="historial-wrap">${historial.map(h=>`
    <div class="historial-item">
      <div class="hi-icon">${h.icon}</div>
      <div class="hi-body">
        <div class="hi-text">${h.texto}${h.submsg?`<br><span style="color:var(--muted);font-size:.72rem">${h.submsg}</span>`:''}</div>
        <div class="hi-time">${formatTs(h.ts)}</div>
      </div>
    </div>`).join('')}</div>`;
}
function clearHistorial(){
  showModal('ğŸ—‘ Limpiar historial','Â¿Confirmas eliminar todos los registros del historial?',()=>{
    historial=[];
    saveHistorial();
    renderHistorialMini();
    closeModal();
    showToast('ğŸ—‘ Historial limpiado');
  });
}
loadHistorial();
loadNotasFromLocal();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BÃšSQUEDA GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function globalSearch(q){
  const res=document.getElementById('globalResults');
  if(!q||q.length<2){ res.classList.remove('show'); return; }
  const norm=q.toLowerCase();
  const found=[];
  const KEYS=['M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'];
  KEYS.forEach(key=>{
    const d=state[key]; if(!d) return;
    const label=key.replace('M-','MaÃ±ana M').replace('T-','Tarde M');
    [...(d.alumnos||[]),...(d.retirados||[])].forEach(a=>{
      if(a.nombre.toLowerCase().includes(norm)){
        found.push({alumno:a,key,label});
      }
    });
  });
  if(found.length===0){
    res.innerHTML=`<div class="gr-empty">No se encontraron alumnos para "${q}"</div>`;
  } else {
    res.innerHTML=found.slice(0,12).map(({alumno,key,label})=>{
      const isRet=alumno.retirado;
      const fecha=today;
      const d=state[key];
      const asist=(d.asistencias[alumno.id]||{})[fecha]||'â€”';
      const totalF=Object.values(d.asistencias[alumno.id]||{}).filter(v=>v==='Falta').length;
      return`<div class="gr-item" onclick="closeGlobalSearch();goPage('${key}')">
        <div class="gr-name">${alumno.nombre}${isRet?` <span style="font-size:.65rem;color:var(--rose)">RETIRADO</span>`:''}</div>
        <div class="gr-sub">${label} Â· Hoy: ${asist} Â· ${totalF} falta(s) totales</div>
      </div>`;
    }).join('');
  }
  res.classList.add('show');
}
function closeGlobalSearch(){
  document.getElementById('globalResults').classList.remove('show');
  document.getElementById('globalSearchInput').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESUMEN MENSUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMensual(){
  const key=document.getElementById('mensualKey')?.value||'M-1';
  const mesInput=document.getElementById('mensualMes')?.value;
  const mes=mesInput||(today.slice(0,7));
  const d=state[key];
  const el=document.getElementById('mensualContent'); if(!el) return;

  if(!d||!d.alumnos||d.alumnos.length===0){
    el.innerHTML=`<div style="color:var(--muted);text-align:center;padding:40px">Sin datos para este mÃ³dulo.</div>`;
    return;
  }

  // Fechas del mes seleccionado
  const fechasMes=d.fechas.filter(f=>f.startsWith(mes));
  const totalClases=fechasMes.length;

  if(totalClases===0){
    el.innerHTML=`<div style="color:var(--muted);text-align:center;padding:40px">Sin clases registradas en ${mes}.</div>`;
    return;
  }

  // Stats globales del mes
  const todos=[...d.alumnos,...(d.retirados||[])];
  let sumPct=0;
  const stats=todos.map(a=>{
    const reg=d.asistencias[a.id]||{};
    const P=fechasMes.filter(f=>reg[f]==='Presente').length;
    const F=fechasMes.filter(f=>reg[f]==='Falta').length;
    const Pm=fechasMes.filter(f=>reg[f]==='Permiso').length;
    const pct=totalClases>0?Math.round(((P+Pm)/totalClases)*100):0;
    sumPct+=pct;
    return{alumno:a,P,F,Pm,pct,isRet:a.retirado};
  }).sort((a,b)=>b.pct-a.pct);

  const avgPct=todos.length>0?Math.round(sumPct/todos.length):0;
  const enRiesgo=stats.filter(s=>s.pct<70&&!s.isRet).length;

  const [y,m]=mes.split('-');
  const meses=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

  el.innerHTML=`
    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
      <div class="stat" style="flex:1;min-width:140px">
        <div class="v amber">${totalClases}</div>
        <div class="l">Clases en el mes</div>
      </div>
      <div class="stat" style="flex:1;min-width:140px">
        <div class="v ${avgPct>=80?'green':avgPct>=60?'yellow':'red'}">${avgPct}%</div>
        <div class="l">Promedio asistencia</div>
      </div>
      <div class="stat" style="flex:1;min-width:140px">
        <div class="v red">${enRiesgo}</div>
        <div class="l">En riesgo (&lt;70%)</div>
      </div>
    </div>
    <h3 style="font-size:.82rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px">
      ${meses[parseInt(m)]} ${y} â€” ${key.replace('M-','MaÃ±ana M').replace('T-','Tarde M')}
    </h3>
    <div class="monthly-grid">
      ${stats.map(({alumno,P,F,Pm,pct,isRet})=>{
        const barCol=pct>=80?'var(--green-l)':pct>=60?'var(--yellow-l)':'var(--red-l)';
        return`<div class="monthly-card" style="${isRet?'opacity:.55':''}">
          <div class="mc-name" title="${alumno.nombre}">${alumno.nombre}${isRet?' <span style="font-size:.6rem;color:var(--rose)">(retirado)</span>':''}</div>
          <div class="mc-stats">
            <span style="color:var(--green-l)">âœ… ${P}</span>
            <span style="color:var(--red-l)">âŒ ${F}</span>
            <span style="color:var(--blue-l)">ğŸ”µ ${Pm}</span>
          </div>
          <div class="mc-bar-track">
            <div class="mc-bar-fill" style="width:${pct}%;background:${barCol}"></div>
          </div>
          <div class="mc-pct" style="color:${barCol}">${pct}%</div>
        </div>`;
      }).join('')}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REACTIVAR ALUMNO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function reactivarAlumno(key,id){
  const d=state[key];
  const alumno=(d.retirados||[]).find(a=>a.id===id); if(!alumno) return;
  showModal(
    'â™»ï¸ Reactivar alumno',
    `Â¿Confirmas reactivar a "${alumno.nombre}"? VolverÃ¡ a la lista de alumnos activos.`,
    async ()=>{
      // Mover de retirados a activos
      d.retirados=d.retirados.filter(a=>a.id!==id);
      alumno.retirado=false;
      d.alumnos.push(alumno);
      d.alumnos.sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}));
      closeModal();
      renderModule(key);
      scheduleSync();

      // Sincronizar con Sheets â€” marcar ACTIVO
      if(GAS_URL && alumno.fila){
        setSyncStatus('saving');
        try{
          await fetch(GAS_URL,{
            method:'POST',mode:'no-cors',
            headers:{'Content-Type':'text/plain'},
            body:JSON.stringify({action:'reactivarAlumno',key,fila:alumno.fila,nombre:alumno.nombre})
          });
          setSyncStatus('cloudsaved');
        }catch(e){ setSyncStatus('error','Error al reactivar en Sheets'); }
      }
      addHistorial('â™»ï¸',`${alumno.nombre} reactivado`,key.replace('M-','MaÃ±ana M').replace('T-','Tarde M'));
      showToast(`â™»ï¸ "${alumno.nombre}" reactivado`);
    }
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE NOTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// notas se guarda en state[key].notas = { [temaId]: { nombre, fecha, notas: {alumnoId: valor} } }

function getNotas(key){
  if(!state[key].notas) state[key].notas={};
  return state[key].notas;
}

// â”€â”€ Mostrar modal para crear nuevo tema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddNotaModal(key){
  const html=`
    <div style="display:flex;flex-direction:column;gap:12px;padding-top:8px">
      <div class="fgroup">
        <div class="flabel">Nombre del tema *</div>
        <input class="finp" id="notaTema" placeholder="Ej: PrÃ¡ctica 1, EvaluaciÃ³n final..." autofocus>
      </div>
      <div class="fgroup">
        <div class="flabel">Nota mÃ­nima aprobatoria</div>
        <input class="finp" id="notaMin" type="number" value="11" min="0" max="20" style="width:90px">
      </div>
    </div>`;
  showModal('ğŸ“ Nuevo tema de evaluaciÃ³n', '', ()=>{
    const nombre = document.getElementById('notaTema')?.value?.trim();
    const min    = parseFloat(document.getElementById('notaMin')?.value)||11;
    if(!nombre){ showToast('âš ï¸ Escribe el nombre del tema'); return; }
    const id = 'tema_' + Date.now();
    const notas = getNotas(key);
    notas[id] = { nombre, min, fecha: today, notas:{} };
    closeModal();
    renderNotas(key);
    localSave();
    addHistorial('ğŸ“', `Nuevo tema: "${nombre}"`, key.replace('M-','MaÃ±ana M').replace('T-','Tarde M'));
    showToast('âœ… Tema creado');
  }, html);
  setTimeout(()=>document.getElementById('notaTema')?.focus(), 100);
}

// â”€â”€ Renderizar todas las tablas de notas del mÃ³dulo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNotas(key){
  const el = document.getElementById(`notas-section-${key}`); if(!el) return;
  const notas = getNotas(key);
  const d = state[key];
  const temas = Object.entries(notas).sort((a,b)=> (b[1].fecha||'').localeCompare(a[1].fecha||''));

  if(temas.length===0){
    el.innerHTML=`<div style="text-align:center;padding:28px;color:var(--muted);font-size:.83rem;background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);">Sin temas de evaluaciÃ³n aÃºn. Presiona <strong>ï¼‹ Nuevo tema</strong> para comenzar.</div>`;
    return;
  }

  el.innerHTML = temas.map(([id, tema])=>{
    const alumnos = d.alumnos||[];
    const vals = Object.values(tema.notas||{}).filter(v=>v!==''&&v!==null&&v!==undefined);
    const ingresadas = vals.length;
    const prom = ingresadas>0 ? (vals.reduce((a,b)=>a+parseFloat(b),0)/ingresadas).toFixed(1) : 'â€”';
    const aprobados = vals.filter(v=>parseFloat(v)>=(tema.min||11)).length;

    const filas = alumnos.map(a=>{
      const val = tema.notas[a.id]!==undefined ? tema.notas[a.id] : '';
      const num  = val!=='' ? parseFloat(val) : null;
      const badge = num===null
        ? '<span class="nota-badge vacio">â€”</span>'
        : num>=(tema.min||11)
          ? '<span class="nota-badge ap">âœ“ Aprobado</span>'
          : '<span class="nota-badge des">âœ— Desap.</span>';
      return `<tr>
        <td><div class="aname">${a.nombre}</div></td>
        <td>
          <input class="nota-inp" type="number" min="0" max="20" step="0.5"
            value="${val}" placeholder="â€”"
            onchange="setNota('${key}','${id}',${a.id},this.value)"
            onblur="setNota('${key}','${id}',${a.id},this.value)">
        </td>
        <td>${badge}</td>
      </tr>`;
    }).join('');

    return `<div class="notas-tema">
      <div class="notas-tema-header" onclick="toggleNotasTema('ntbody-${key}-${id}')">
        <span class="notas-tema-title">ğŸ“‹ ${tema.nombre}</span>
        <span class="notas-tema-stats">
          <span>${ingresadas}/${alumnos.length} notas</span>
          <span>Prom: ${prom}</span>
          <span>${aprobados} aprobados</span>
        </span>
        <span class="notas-tema-badge">Min: ${tema.min||11}</span>
        <button class="btn btn-red" style="padding:3px 9px;font-size:.7rem;margin-left:8px" onclick="event.stopPropagation();eliminarTema('${key}','${id}')">âœ•</button>
      </div>
      <div class="notas-table-wrap" id="ntbody-${key}-${id}">
        <table style="width:100%">
          <thead><tr>
            <th>Alumno</th><th style="width:110px">Nota (0â€“20)</th><th style="width:130px">Estado</th>
          </tr></thead>
          <tbody>${filas}</tbody>
        </table>
      </div>
    </div>`;
  }).join('');
}

function toggleNotasTema(id){
  const el=document.getElementById(id); if(!el) return;
  el.style.display = el.style.display==='none' ? '' : 'none';
}

// â”€â”€ Guardar una nota individual â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setNota(key, temaId, alumnoId, valor){
  const notas = getNotas(key);
  if(!notas[temaId]) return;
  const num = valor===''||valor===null ? '' : parseFloat(valor);
  notas[temaId].notas[alumnoId] = isNaN(num) ? '' : num;
  // Re-render solo stats del header sin rerenderizar toda la tabla
  renderNotasHeader(key, temaId);
  localSave();
  // Sincronizar con Sheets
  syncNota(key, temaId, alumnoId, notas[temaId].notas[alumnoId]);
}

function renderNotasHeader(key, temaId){
  // Actualiza solo el header del tema sin destruir los inputs
  const notas = getNotas(key);
  const tema  = notas[temaId]; if(!tema) return;
  const d     = state[key];
  const vals  = Object.values(tema.notas||{}).filter(v=>v!==''&&v!==null&&v!==undefined&&!isNaN(v));
  const prom  = vals.length>0 ? (vals.reduce((a,b)=>a+parseFloat(b),0)/vals.length).toFixed(1) : 'â€”';
  const aprobados = vals.filter(v=>parseFloat(v)>=(tema.min||11)).length;
  const statsEl = document.querySelector(`#ntbody-${key}-${temaId}`)?.previousElementSibling?.querySelector('.notas-tema-stats');
  if(statsEl) statsEl.innerHTML=`
    <span>${vals.length}/${(d.alumnos||[]).length} notas</span>
    <span>Prom: ${prom}</span>
    <span>${aprobados} aprobados</span>`;
  // Actualizar badges de la columna estado
  const tbody = document.querySelector(`#ntbody-${key}-${temaId} tbody`);
  if(!tbody) return;
  (d.alumnos||[]).forEach((a,idx)=>{
    const val  = tema.notas[a.id];
    const num  = val!==undefined&&val!=='' ? parseFloat(val) : null;
    const td   = tbody.rows[idx]?.cells[2]; if(!td) return;
    td.innerHTML = num===null
      ? '<span class="nota-badge vacio">â€”</span>'
      : num>=(tema.min||11)
        ? '<span class="nota-badge ap">âœ“ Aprobado</span>'
        : '<span class="nota-badge des">âœ— Desap.</span>';
  });
}

// â”€â”€ Eliminar tema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eliminarTema(key, temaId){
  const notas = getNotas(key);
  const nombre = notas[temaId]?.nombre||'este tema';
  showModal('ğŸ—‘ Eliminar tema',`Â¿Confirmas eliminar "${nombre}" y todas sus notas?`,()=>{
    delete notas[temaId];
    closeModal();
    renderNotas(key);
    localSave();
    syncEliminarTema(key, temaId);
    showToast(`ğŸ—‘ Tema "${nombre}" eliminado`);
  });
}

// â”€â”€ Sync notas con Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncNota(key, temaId, alumnoId, valor){
  const notas = getNotas(key);
  const tema  = notas[temaId]; if(!tema) return;
  const alumno = state[key]?.alumnos.find(a=>a.id===alumnoId); if(!alumno) return;
  gasPost({
    action:  'setNota',
    key,
    temaId,
    temaNombre: tema.nombre,
    alumnoNombre: alumno.nombre,
    alumnoFila: alumno.fila,
    valor: valor===''||valor===null ? '' : parseFloat(valor)
  });
}

function syncEliminarTema(key, temaId){
  gasPost({ action:'eliminarTema', key, temaId });
}

// Cargar notas desde localStorage al iniciar (se guardan junto con state)
function loadNotasFromLocal(){
  const KEYS=['M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'];
  try{
    const raw=localStorage.getItem('asist_notas');
    if(!raw) return;
    const saved=JSON.parse(raw);
    KEYS.forEach(k=>{ if(saved[k]) { if(!state[k]) state[k]={}; state[k].notas=saved[k]; } });
  }catch(e){}
}

function saveNotasToLocal(){
  const KEYS=['M-1','M-2','M-3','M-4','T-1','T-2','T-3','T-4'];
  const out={};
  KEYS.forEach(k=>{ if(state[k]?.notas) out[k]=state[k].notas; });
  try{ localStorage.setItem('asist_notas', JSON.stringify(out)); }catch(e){}
}

// Patch localSave para incluir notas
const _origLocalSave = localSave;
function localSave(){
  _origLocalSave();
  saveNotasToLocal();
}
</script>
</body>
</html>
